# -*- coding: utf-8 -*-
# ba_meta require api 6

#  AdvancedPartyWindow v5.3  by Mr.Smoothy 
# built over ModifyPartyWindow.py  (Plasma Boson)

# DONT MODIFY OR RELEASE SOURCE CODE ANYWHERE !

# Have any idea/suggestion/bug report  >  send message on discord mr.smoothy#5824

# Discord:-
# mr.smoothy#5824 
# Plasma Boson#4104

# DONT EDIT ANYTHING WITHOUT PERMISSION 

# join Bombspot - bombsquad biggest modding community .... open for everyone  https://discord.gg/2RKd9QQdQY
# join Bombsquad Consultancy Service - for more mods, modding help for all modders and server owners 
# https://discord.gg/ucyaesh

# if you got this file from somewhere else , dont forget to join above servers - release point of mods 

# Advanced Party Window equipped with many new features - join above server to get complete details


# if you are server owner and reposting this mod on your server : dont forget to mention credits :) 


# https://discord.gg/2RKd9QQdQY
# https://discord.gg/ucyaesh

# I am current(2021) maintainer for Modifypartywindow.py /  Advancepartywindow.py 
# contact me if have any problem - mr.smoothy#5824

# REQUIREMENTS
# built for bs 1.5.29 and above , target bs 1.6 - also need newserverconnector.py(for 1.5.29) (optional)  for  extra functionality

version_str = "5.3.0"
exec('import re,base64,string')

# hide on screen message

exec(base64.b64decode("IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KIyBiYV9tZXRhIHJlcXVpcmUgYXBpIDYKCgoKIyBBZHZhbmNlZFBhcnR5V2luZG93IGJ5IE1yLlNtb290aHkgCgojIGJ1aWxkIG9uIGJhc2Ugb2YgcGxhc21hJ3MgbW9kaWZ5cGFydHl3aW5kb3cgCgojIGFkZGVkIG1hbnkgZmVhdHVyZXMgCgojIGRpc2NvcmQgbXIuc21vb3RoeSM1ODI0CgojIGRvIG5vdCBtb2RpZnkgb3IgcmVsZWFzZSAgdGhpcyBzb3VyY2UgY29kZSB3aGljaCB1IGFscmVhZHkgZGVjcnlwdGVkIAoKCgoKI01hZGUgYnkgTXIuU21vb3RoeSAtIFBsYXNtYSBCb3Nvbgp2ZXJzaW9uX3N0ciA9ICI1LjMiCgppbXBvcnQgb3MsdXJsbGliCmltcG9ydCBvcyxzeXMscmUsanNvbixjb2RlY3MsdHJhY2ViYWNrLGJhc2U2NAppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCB0aW1lLGNvcHksZGF0ZXRpbWUsc2h1dGlsCgpmcm9tIF90aHJlYWQgaW1wb3J0IHN0YXJ0X25ld190aHJlYWQKCgoKZnJvbSB0eXBpbmcgaW1wb3J0IFRZUEVfQ0hFQ0tJTkcsIGNhc3QKCmltcG9ydCBfYmEKaW1wb3J0IGJhCmltcG9ydCB0aW1lCmltcG9ydCBtYXRoCmltcG9ydCB0aHJlYWRpbmcKZnJvbSBkYXRhY2xhc3NlcyBpbXBvcnQgZGF0YWNsYXNzCmZyb20gYmFzdGQudWkucG9wdXAgaW1wb3J0IFBvcHVwTWVudVdpbmRvdyxQb3B1cFdpbmRvdwpmcm9tIGJhc3RkLnVpLmNvbmZpcm0gaW1wb3J0IENvbmZpcm1XaW5kb3cKZnJvbSBiYXN0ZC51aS5jb2xvcnBpY2tlciBpbXBvcnQgQ29sb3JQaWNrZXJFeGFjdAoKZnJvbSB0eXBpbmcgaW1wb3J0IExpc3QsIFNlcXVlbmNlLCBPcHRpb25hbCwgRGljdCwgQW55LCBVbmlvbgoKaW1wb3J0IGJhc3RkLnVpLnBhcnR5IGFzIGJhc3RkX3BhcnR5CmNhY2hlX2NoYXQ9W10KY29ubmVjdD1fYmEuY29ubmVjdF90b19wYXJ0eQpkaXNjb25uZWN0PV9iYS5kaXNjb25uZWN0X2Zyb21faG9zdAp1bm11dGVkX25hbWVzPVtdCnNtb19tb2RlPTMKZl9jaGF0PUZhbHNlCmNoYXRsb2dnZXI9RmFsc2UKc2NyZWVubXNnPVRydWUKaXBfYWRkPSIxMjcuMC4wLjEiCnBfcG9ydD00MzIxMApwX25hbWU9ImxvY2FsIgpkZWYgbmV3Y29ubmVjdF90b19wYXJ0eShhZGRyZXNzLHBvcnQ9NDMyMTAscHJpbnRfcHJvZ3Jlc3M9RmFsc2UpOgogICAgZ2xvYmFsIGlwX2FkZAogICAgZ2xvYmFsIHBfcG9ydAogICAgZGQ9X2JhLmdldF9jb25uZWN0aW9uX3RvX2hvc3RfaW5mbygpCiAgICBpZihkZCE9e30gKToKICAgICAgICBfYmEuZGlzY29ubmVjdF9mcm9tX2hvc3QoKQogICAgICAgIAogICAgICAgIGlwX2FkZD1hZGRyZXNzCiAgICAgICAgcF9wb3J0PXBvcnQKICAgICAgICBjb25uZWN0KGFkZHJlc3MscG9ydCxwcmludF9wcm9ncmVzcykKICAgIGVsc2U6CiAgICAgICAgCiAgICAKICAgICAgICBpcF9hZGQ9YWRkcmVzcwogICAgICAgIHBfcG9ydD1wb3J0CiAgICAgICAgIyBwcmludChpcF9hZGQscF9wb3J0KQogICAgICAgIGNvbm5lY3QoaXBfYWRkLHBvcnQscHJpbnRfcHJvZ3Jlc3MpCgoKIiIiCmltcG9ydCBicwppbXBvcnQgZGF0ZXRpbWUsc2h1dGlsCmltcG9ydCBic0ludGVybmFsCmZyb20gYnNVSSBpbXBvcnQgKgppbXBvcnQgYnNVSQpmcm9tIGJzVUkyIGltcG9ydCBTaGFyZVBsYXlsaXN0SW1wb3J0V2luZG93CmltcG9ydCBvcyxzeXMscmUsanNvbixjb2RlY3MsdHJhY2ViYWNrCgoiIiIKREVCVUdfU0VSVkVSX0NPTU1VTklDQVRJT04gPSBGYWxzZQpERUJVR19QUk9DRVNTSU5HID0gRmFsc2UKY2xhc3MgUGluZ1RocmVhZCh0aHJlYWRpbmcuVGhyZWFkKToKICAgICIiIlRocmVhZCBmb3Igc2VuZGluZyBvdXQgZ2FtZSBwaW5ncy4iIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgYWRkcmVzczogc3RyLCBwb3J0OiBpbnQpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKQogICAgICAgIHNlbGYuX2FkZHJlc3MgPSBhZGRyZXNzCiAgICAgICAgc2VsZi5fcG9ydCA9IHBvcnQKICAgICAgICAKCiAgICBkZWYgcnVuKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgIyBweWxpbnQ6IGRpc2FibGU9dG9vLW1hbnktYnJhbmNoZXMKICAgICAgICAjIHB5bGludDogZGlzYWJsZT10b28tbWFueS1zdGF0ZW1lbnRzCiAgICAgICAgYmEuYXBwLnBpbmdfdGhyZWFkX2NvdW50ICs9IDEKICAgICAgICBzb2NrOiBPcHRpb25hbFtzb2NrZXQuc29ja2V0XSA9IE5vbmUKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBzb2NrZXQKICAgICAgICAgICAgZnJvbSBiYS5pbnRlcm5hbCBpbXBvcnQgZ2V0X2lwX2FkZHJlc3NfdHlwZQogICAgICAgICAgICBzb2NrZXRfdHlwZSA9IGdldF9pcF9hZGRyZXNzX3R5cGUoc2VsZi5fYWRkcmVzcykKICAgICAgICAgICAgc29jayA9IHNvY2tldC5zb2NrZXQoc29ja2V0X3R5cGUsIHNvY2tldC5TT0NLX0RHUkFNKQogICAgICAgICAgICBzb2NrLmNvbm5lY3QoKHNlbGYuX2FkZHJlc3MsIHNlbGYuX3BvcnQpKQoKICAgICAgICAgICAgYWNjZXNzaWJsZSA9IEZhbHNlCiAgICAgICAgICAgIHN0YXJ0dGltZSA9IHRpbWUudGltZSgpCgogICAgICAgICAgICAjIFNlbmQgYSBmZXcgcGluZ3MgYW5kIHdhaXQgYSBzZWNvbmQgZm9yCiAgICAgICAgICAgICMgYSByZXNwb25zZS4KICAgICAgICAgICAgc29jay5zZXR0aW1lb3V0KDEpCiAgICAgICAgICAgIGZvciBfaSBpbiByYW5nZSgzKToKICAgICAgICAgICAgICAgIHNvY2suc2VuZChiJ1x4MGInKQogICAgICAgICAgICAgICAgcmVzdWx0OiBPcHRpb25hbFtieXRlc10KICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIDExOiBCQV9QQUNLRVRfU0lNUExFX1BJTkcKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBzb2NrLnJlY3YoMTApCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IE5vbmUKICAgICAgICAgICAgICAgIGlmIHJlc3VsdCA9PSBiJ1x4MGMnOgogICAgICAgICAgICAgICAgICAgICMgMTI6IEJBX1BBQ0tFVF9TSU1QTEVfUE9ORwogICAgICAgICAgICAgICAgICAgIGFjY2Vzc2libGUgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKICAgICAgICAgICAgcGluZyA9ICh0aW1lLnRpbWUoKSAtIHN0YXJ0dGltZSkgKiAxMDAwLjAKICAgICAgICAgICAgX2JhLmNoYXRtZXNzYWdlKCJNeSBwaW5nIDoiK3N0cihyb3VuZChwaW5nLDIpKSsiIG1zIikKICAgICAgICBleGNlcHQgQ29ubmVjdGlvblJlZnVzZWRFcnJvcjoKICAgICAgICAgICAgIyBGaW5lLCBzZXJ2ZXI7IHNvcnJ5IHdlIHBpbmdlZCB5b3UuIEhtcGguCiAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgT1NFcnJvciBhcyBleGM6CiAgICAgICAgICAgIGltcG9ydCBlcnJubwoKICAgICAgICAgICAgIyBJZ25vcmUgaGFybWxlc3MgZXJyb3JzLgogICAgICAgICAgICBpZiBleGMuZXJybm8gaW4gewogICAgICAgICAgICAgICAgICAgIGVycm5vLkVIT1NUVU5SRUFDSCwgZXJybm8uRU5FVFVOUkVBQ0gsIGVycm5vLkVJTlZBTCwKICAgICAgICAgICAgICAgICAgICBlcnJuby5FUEVSTSwgZXJybm8uRUFDQ0VTCiAgICAgICAgICAgIH06CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGVsaWYgZXhjLmVycm5vID09IDEwMDIyOgogICAgICAgICAgICAgICAgIyBXaW5kb3dzICdpbnZhbGlkIGFyZ3VtZW50JyBlcnJvci4KICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgZWxpZiBleGMuZXJybm8gPT0gMTAwNTE6CiAgICAgICAgICAgICAgICAjIFdpbmRvd3MgJ2Egc29ja2V0IG9wZXJhdGlvbiB3YXMgYXR0ZW1wdGVkCiAgICAgICAgICAgICAgICAjIHRvIGFuIHVucmVhY2hhYmxlIG5ldHdvcmsnIGVycm9yLgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBlbGlmIGV4Yy5lcnJubyA9PSBlcnJuby5FQUREUk5PVEFWQUlMOgogICAgICAgICAgICAgICAgaWYgc2VsZi5fcG9ydCA9PSAwOgogICAgICAgICAgICAgICAgICAgICMgVGhpcyBoYXMgaGFwcGVuZWQuIElnbm9yZS4KICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBlbGlmIGJhLmRvX29uY2UoKToKICAgICAgICAgICAgICAgICAgICBwcmludChmJ0dvdCBFQUREUk5PVEFWQUlMIG9uIGdhdGhlciBwaW5nJwogICAgICAgICAgICAgICAgICAgICAgICAgIGYnIGZvciBhZGRyIHtzZWxmLl9hZGRyZXNzfScKICAgICAgICAgICAgICAgICAgICAgICAgICBmJyBwb3J0IHtzZWxmLl9wb3J0fS4nKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYmEucHJpbnRfZXhjZXB0aW9uKAogICAgICAgICAgICAgICAgICAgIGYnRXJyb3Igb24gZ2F0aGVyIHBpbmcgJwogICAgICAgICAgICAgICAgICAgIGYnKGVycm5vPXtleGMuZXJybm99KScsIG9uY2U9VHJ1ZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBiYS5wcmludF9leGNlcHRpb24oJ0Vycm9yIG9uIGdhdGhlciBwaW5nJywgb25jZT1UcnVlKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIHNvY2sgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgc29jay5jbG9zZSgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBiYS5wcmludF9leGNlcHRpb24oJ0Vycm9yIG9uIGdhdGhlciBwaW5nIGNsZWFudXAnLCBvbmNlPVRydWUpCgogICAgICAgIGJhLmFwcC5waW5nX3RocmVhZF9jb3VudCAtPSAxCnRyeToKICAgIGltcG9ydCBPbmxpbmVUcmFuc2xhdG9yCiAgICB0cmFuVHlwZXMgPSBbaXRlbSBmb3IgaXRlbSBpbiBkaXIoT25saW5lVHJhbnNsYXRvcikgaWYgaXRlbS5zdGFydHN3aXRoKCJUcmFuc2xhdG9yXyIpXQogICAgaWYgIml0ZW0iIGluIGdsb2JhbHMoKTpkZWwgaXRlbQpleGNlcHQ6dHJhblR5cGVzID0gW10jO2JhLnByaW50X2V4Y2VwdGlvbigpCgpSZWNvcmRGaWxlc0RpciA9IG9zLnBhdGguam9pbihfYmEuZW52KClbInB5dGhvbl9kaXJlY3RvcnlfdXNlciJdLCJDb25maWdzIiArIG9zLnNlcCkKaWYgbm90IG9zLnBhdGguZXhpc3RzKFJlY29yZEZpbGVzRGlyKTpvcy5tYWtlZGlycyhSZWNvcmRGaWxlc0RpcikKCnZlcnNpb25fc3RyID0gIjMuMC4xIgoKQ3VycmVudF9MYW5nID0gTm9uZQoKU3lzdGVtRW5jb2RlID0gc3lzLmdldGZpbGVzeXN0ZW1lbmNvZGluZygpCmlmIG5vdCBpc2luc3RhbmNlKFN5c3RlbUVuY29kZSxzdHIpOgogICAgU3lzdGVtRW5jb2RlID0gInV0Zi04IgoKCmltcG9ydCBkYXRldGltZQpmcm9tIGJhLl9lbnVtcyBpbXBvcnQgVGltZVR5cGUKY2xhc3MgY2hhdGxvZ2dUaHJlYWQoKToKICAgICIiIlRocmVhZCBmb3Igc2VuZGluZyBvdXQgZ2FtZSBwaW5ncy4iIiIKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpCiAgICAgICAgCiAgICAgICAgc2VsZi5zYXZlZF9tc2c9W10KICAgICAgICAKCiAgICBkZWYgcnVuKHNlbGYpIC0+IE5vbmU6CgogICAgICAgICMgcHlsaW50OiBkaXNhYmxlPXRvby1tYW55LWJyYW5jaGVzCiAgICAgICAgIyBweWxpbnQ6IGRpc2FibGU9dG9vLW1hbnktc3RhdGVtZW50cwogICAgICAgIGdsb2JhbCBjaGF0bG9nZ2VyCiAgICAgICAgCiAgICAgICAgc2VsZi50aW1lcnI9YmEuVGltZXIoNS4wLHNlbGYuY2hhdGxvZ2cscmVwZWF0PVRydWUsdGltZXR5cGU9VGltZVR5cGUuUkVBTCkKICAgICAgICAKCgogICAgZGVmIGNoYXRsb2dnKHNlbGYpOgogICAgICBnbG9iYWwgY2hhdGxvZ2dlcgogICAgICAKICAgICAgY2hhdHM9X2JhLmdldF9jaGF0X21lc3NhZ2VzKCkKICAgICAgZm9yIG1zZyBpbiBjaGF0czoKICAgICAgICAKICAgICAgICBpZiBtc2cgaW4gc2VsZi5zYXZlZF9tc2c6CiAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgIHNlbGYuc2F2ZShtc2cpCiAgICAgICAgICBzZWxmLnNhdmVkX21zZy5hcHBlbmQobXNnKQogICAgICAgICAgaWYgbGVuKHNlbGYuc2F2ZWRfbXNnKSA+IDQ1OgogICAgICAgICAgICBzZWxmLnNhdmVkX21zZy5wb3AoMCkKICAgICAgaWYgY2hhdGxvZ2dlcjoKICAgICAgICBwYXNzCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgIGVsc2U6CiAgICAgICAgc2VsZi50aW1lcnI9Tm9uZQogICAgICAgIAoKICAgIGRlZiBzYXZlKHNlbGYsbXNnKToKICAgICAgCiAgICAgIHg9c3RyKGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpKQogICAgICB0PW9wZW4ob3MucGF0aC5qb2luKF9iYS5lbnYoKVsicHl0aG9uX2RpcmVjdG9yeV91c2VyIl0sIkNoYXQgbG9nZ2VkLnR4dCIpLCJhKyIpCiAgICAgIHQud3JpdGUoeCsiIDogIisgbXNnICsiXG4iKQogICAgICB0LmNsb3NlKCkKCmNsYXNzIGN1c3RvbWNoYXRUaHJlYWQoKToKICAgICIiIlRocmVhZCBmb3Igc2VuZGluZyBvdXQgZ2FtZSBwaW5ncy4iIiIKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpCiAgICAgICAgZ2xvYmFsIGNhY2hlX2NoYXQKICAgICAgICBzZWxmLnNhdmVkX21zZz1bXQogICAgICAgIGNoYXRzPV9iYS5nZXRfY2hhdF9tZXNzYWdlcygpCiAgICAgICAgZm9yIG1zZyBpbiBjaGF0czogICNmaWxsIHVwIG9sZCAgY2hhdCAsIHRvIGF2b2lkIG9sZCBtc2cgcG9wdXAKICAgICAgICAJY2FjaGVfY2hhdC5hcHBlbmQobXNnKQogICAgICAgIAoKICAgIGRlZiBydW4oc2VsZikgLT4gTm9uZToKCiAgICAgICAgIyBweWxpbnQ6IGRpc2FibGU9dG9vLW1hbnktYnJhbmNoZXMKICAgICAgICAjIHB5bGludDogZGlzYWJsZT10b28tbWFueS1zdGF0ZW1lbnRzCiAgICAgICAgZ2xvYmFsIGNoYXRsb2dnZXIKICAgICAgICAKICAgICAgICBzZWxmLnRpbWVycj1iYS5UaW1lcig1LjAsc2VsZi5jaGF0Y2hlY2sscmVwZWF0PVRydWUsdGltZXR5cGU9VGltZVR5cGUuUkVBTCkKICAgICAgICAKCgogICAgZGVmIGNoYXRjaGVjayhzZWxmKToKICAgICAgZ2xvYmFsIHVubXV0ZWRfbmFtZXMKICAgICAgZ2xvYmFsIGNhY2hlX2NoYXQKICAgICAgY2hhdHM9X2JhLmdldF9jaGF0X21lc3NhZ2VzKCkKICAgICAgZm9yIG1zZyBpbiBjaGF0czoKICAgICAgICAKICAgICAgICBpZiBtc2cgaW4gY2FjaGVfY2hhdDoKICAgICAgICAgIHBhc3MKICAgICAgICBlbHNlOgoKICAgICAgICAgICAgaWYgbXNnLnNwbGl0KCI6IilbMF0gaW4gdW5tdXRlZF9uYW1lczoKICAgICAgICAgICAgICAgIGJhLnNjcmVlbm1lc3NhZ2UobXNnLGNvbG9yPSgwLjYsMC45LDAuNikpCiAgICAgICAgICAgIGNhY2hlX2NoYXQuYXBwZW5kKG1zZykKICAgICAgICAgICAgaWYgbGVuKHNlbGYuc2F2ZWRfbXNnKSA+IDQ1OgogICAgICAgICAgICAgICAgY2FjaGVfY2hhdC5wb3AoMCkKICAgICAgICBpZiBiYS5hcHAuY29uZmlnLnJlc29sdmUoJ0NoYXQgTXV0ZWQnKToKICAgICAgICAgICAgcGFzcwogICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYudGltZXJyPU5vbmUKICAgICAgICAKCiAgICAKCmRlZiBjaGF0bG9nZ2Vyc3RhdHVzKCk6CiAgZ2xvYmFsIGNoYXRsb2dnZXIKICBpZiBjaGF0bG9nZ2VyOgogICAgcmV0dXJuICJUdXJuIG9mZiBDaGF0IExvZ2dlciIKICBlbHNlOgogICAgcmV0dXJuICJUdXJuIG9uIGNoYXQgbG9nZ2VyIgoKZGVmIF9nZXRUcmFuc1RleHQodGV4dCAsIGlzQmFMc3RyID0gRmFsc2UgLCBzYW1lX2ZiID0gRmFsc2UpOgogICAgZ2xvYmFsIEN1cnJlbnRfTGFuZwogICAgZ2xvYmFsIGNoYXRsb2dnZXIKICAgIGlmIEN1cnJlbnRfTGFuZyAhPSAnRW5nbGlzaCc6CiAgICAgICAgQ3VycmVudF9MYW5nID0gJ0VuZ2xpc2gnCiAgICAgICAgZ2xvYmFsIExhbmd1YWdlX1RleHRzCiAgICAgICAgTGFuZ3VhZ2VfVGV4dHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkNoaW5lc2UiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkVuZ2xpc2giOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJBZGRfYV9RdWlja19SZXBseSI6ICJBZGQgYSBRdWljayBSZXBseSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJBZG1pbl9Db21tYW5kX0tpY2tfQ29uZmlybSI6ICJBcmUgeW91IHN1cmUgdG8gdXNlIGFkbWluXApjb21tYW5kIHRvIGtpY2sgJXM/IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkJhbl9Gb3JfJWRfU2Vjb25kcyI6ICJCYW4gZm9yICVkIHNlY29uZChzKS4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiQmFuX1RpbWVfUG9zdCI6ICJFbnRlciB0aGUgdGltZSB5b3Ugd2FudCB0byBiYW4oU2Vjb25kcykuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkNyZWRpdHNfZm9yX1RoaXMiOiAiQ3JlZGl0cyBmb3IgVGhpcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJDdXN0b21fQWN0aW9uIjogIkN1c3RvbSBBY3Rpb24iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiRGVidWdfZm9yX0hvc3RfSW5mbyI6ICJIb3N0IEluZm8gRGVidWciLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiR2FtZV9SZWNvcmRfU2F2ZWQiOiAiR2FtZSByZXBsYXkgJXMgaXMgc2F2ZWQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIktpY2tfSUQiOiAiS2ljayBJRDolZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJNZW50aW9uX3RoaXNfZ3V5IjogIk1lbnRpb24gdGhpcyBndXkiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiTW9kaWZ5X01haW5fQ29sb3IiOiAiTW9kaWZ5IE1haW4gQ29sb3IiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiTm9fdmFsaWRfcGxheWVyX2ZvdW5kIjogIkNhbid0IGZpbmQgYSB2YWxpZCBwbGF5ZXIuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIk5vX3ZhbGlkX3BsYXllcl9pZF9mb3VuZCI6ICJDYW4ndCBmaW5kIGEgdmFsaWQgcGxheWVyIElELiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJOb3JtYWxfa2lja19jb25maXJtIjogIkFyZSB5b3Ugc3VyZSB0byBraWNrICVzPyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJSZW1vdmVfYV9RdWlja19SZXBseSI6ICJSZW1vdmUgYSBRdWljayBSZXBseSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJSZXN0YXJ0X0dhbWVfUmVjb3JkIjogIlNhdmUgUmVjb3JkaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIlJlc3RhcnRfR2FtZV9SZWNvcmRfQ29uZmlybSI6ICJBcmUgeW91IHN1cmUgdG8gcmVzdGFydCByZWNvcmRpbmcgZ2FtZSBzdHJlYW0/IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIlNlbmRfJWRfdGltZXMiOiAiU2VuZCBmb3IgJWQgdGltZXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiU29tZXRoaW5nX2lzX2FkZGVkIjogIiclcycgaXMgYWRkZWQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIlNvbWV0aGluZ19pc19yZW1vdmVkIjogIiclcycgaXMgcmVtb3ZlZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiVGltZXMiOiAiVGltZXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiVHJhbnNsYXRvciI6ICJUcmFuc2xhdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNoYXRsb2dnZXJvZmYiOiJUdXJuIG9mZiBDaGF0IExvZ2dlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGF0bG9nZ2Vyb24iOiJUdXJuIG9uIENoYXQgTG9nZ2VyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInNjcmVlbm1zZ29mZiI6IkhpZGUgU2NyZWVuTWVzc2FnZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzY3JlZW5tc2dvbiI6IlNob3cgU2NyZWVuTWVzc2FnZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ1bm11dGV0aGlzZ3V5IjoidW5tdXRlIHRoaXMgZ3V5IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm11dGV0aGlzZ3V5IjoibXV0ZSB0aGlzIGd1eSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtdXRlYWxsIjoiTXV0ZSBhbGwiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidW5tdXRlYWxsIjoiVW5tdXRlIGFsbCIKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgCiAgICAgICAgTGFuZ3VhZ2VfVGV4dHMgPSBMYW5ndWFnZV9UZXh0cy5nZXQoQ3VycmVudF9MYW5nKQogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBMYW5ndWFnZV9QYWNrcyBpbXBvcnQgTW9kaWZpZWRQYXJ0eVdpbmRvd19MYW5ndWFnZVBhY2sgYXMgZXh0X2xhbl9wYWNrCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZXh0X2xhbl9wYWNrLGRpY3QpIGFuZCBpc2luc3RhbmNlKGV4dF9sYW5fcGFjay5nZXQoQ3VycmVudF9MYW5nKSxkaWN0KToKICAgICAgICAgICAgICAgIGNvbXBsZXRlX1BhY2sgPSBleHRfbGFuX3BhY2suZ2V0KEN1cnJlbnRfTGFuZykKICAgICAgICAgICAgICAgIGZvciBrZXksaXRlbSBpbiBjb21wbGV0ZV9QYWNrLml0ZW1zKCk6CiAgICAgICAgICAgICAgICAgICAgTGFuZ3VhZ2VfVGV4dHNba2V5XSA9IGl0ZW0KICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKICAgIAogICAgcmV0dXJuKExhbmd1YWdlX1RleHRzLmdldCh0ZXh0LCIjVW5rbm93biBUZXh0IyIgaWYgbm90IHNhbWVfZmIgZWxzZSB0ZXh0KSBpZiBub3QgaXNCYUxzdHIgZWxzZQogICAgICAgICAgIGJhLkxzdHIocmVzb3VyY2UgPSAiPz9Vbmtub3duPz8iLGZhbGxiYWNrX3ZhbHVlID0gTGFuZ3VhZ2VfVGV4dHMuZ2V0KHRleHQsIiNVbmtub3duIFRleHQjIiBpZiBub3Qgc2FtZV9mYiBlbHNlIHRleHQpKSkKCmRlZiBfZ2V0X3BvcHVwX3dpbmRvd19zY2FsZSgpIC0+IGZsb2F0OgogICAgdWlzY2FsZSA9IGJhLmFwcC51aS51aXNjYWxlCiAgICByZXR1cm4oMi4zIGlmIHVpc2NhbGUgaXMgYmEuVUlTY2FsZS5TTUFMTCBlbHNlCiAgICAgICAgICAgICAgICAgICAxLjY1IGlmIHVpc2NhbGUgaXMgYmEuVUlTY2FsZS5NRURJVU0gZWxzZSAxLjIzKQoKZGVmIF9jcmVhdF9Mc3RyX2xpc3Qoc3RyaW5nX2xpc3QgOiBsaXN0ID0gW10pIC0+IGxpc3Q6CiAgICByZXR1cm4oW2JhLkxzdHIocmVzb3VyY2UgPSAiPz9Vbmtub3duPz8iLGZhbGxiYWNrX3ZhbHVlID0gaXRlbSkgZm9yIGl0ZW0gaW4gc3RyaW5nX2xpc3RdKQogICAgCgoKCmN1c3RvbWNoYXRUaHJlYWQoKS5ydW4oKQoKY2xhc3MgTW9kaWZpZWRQYXJ0eVdpbmRvdyhiYXN0ZF9wYXJ0eS5QYXJ0eVdpbmRvdyk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgb3JpZ2luOiBTZXF1ZW5jZVtmbG9hdF0gPSAoMCwgMCkpOgogICAgICAgIF9iYS5zZXRfcGFydHlfd2luZG93X29wZW4oVHJ1ZSkKICAgICAgICBzZWxmLl9yID0gJ3BhcnR5V2luZG93JwogICAgICAgIHNlbGYubXNnX3VzZXJfc2VsZWN0ZWQ9JycKICAgICAgICBzZWxmLl9wb3B1cF90eXBlOiBPcHRpb25hbFtzdHJdID0gTm9uZQogICAgICAgIHNlbGYuX3BvcHVwX3BhcnR5X21lbWJlcl9jbGllbnRfaWQ6IE9wdGlvbmFsW2ludF0gPSBOb25lCiAgICAgICAgc2VsZi5fcG9wdXBfcGFydHlfbWVtYmVyX2lzX2hvc3Q6IE9wdGlvbmFsW2Jvb2xdID0gTm9uZQogICAgICAgIHNlbGYuX3dpZHRoID0gNTAwCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdWlzY2FsZSA9IGJhLmFwcC51aS51aXNjYWxlCiAgICAgICAgc2VsZi5faGVpZ2h0ID0gKDM2NSBpZiB1aXNjYWxlIGlzIGJhLlVJU2NhbGUuU01BTEwgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICA0ODAgaWYgdWlzY2FsZSBpcyBiYS5VSVNjYWxlLk1FRElVTSBlbHNlIDYwMCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgI0N1c3RvbSBjb2xvciBoZXJlCiAgICAgICAgc2VsZi5fYmdfY29sb3IgPSBiYS5hcHAuY29uZmlnLmdldCgiUGFydHlXaW5kb3dfTWFpbl9Db2xvciIsKDAuNDAsIDAuNTUsIDAuMjApKSBpZiBub3QgaXNpbnN0YW5jZShzZWxmLl9nZXRDdXN0b21TZXRzKCkuZ2V0KCJDb2xvciIpLChsaXN0LHR1cGxlKSkgZWxzZSBzZWxmLl9nZXRDdXN0b21TZXRzKCkuZ2V0KCJDb2xvciIpCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uoc2VsZi5fYmdfY29sb3IsKGxpc3QsdHVwbGUpKSBvciBub3QgbGVuKHNlbGYuX2JnX2NvbG9yKSA9PSAzOnNlbGYuX2JnX2NvbG9yID0gKDAuNDAsIDAuNTUsIDAuMjApCiAgICAgICAgCgogICAgICAgIAoKICAgICAgICBiYS5XaW5kb3cuX19pbml0X18oc2VsZixyb290X3dpZGdldD1iYS5jb250YWluZXJ3aWRnZXQoCiAgICAgICAgICAgIHNpemU9KHNlbGYuX3dpZHRoLCBzZWxmLl9oZWlnaHQpLAogICAgICAgICAgICB0cmFuc2l0aW9uPSdpbl9zY2FsZScsCiAgICAgICAgICAgIGNvbG9yPXNlbGYuX2JnX2NvbG9yLAogICAgICAgICAgICBwYXJlbnQ9X2JhLmdldF9zcGVjaWFsX3dpZGdldCgnb3ZlcmxheV9zdGFjaycpLAogICAgICAgICAgICBvbl9vdXRzaWRlX2NsaWNrX2NhbGw9c2VsZi5jbG9zZV93aXRoX3NvdW5kLAogICAgICAgICAgICBzY2FsZV9vcmlnaW5fc3RhY2tfb2Zmc2V0PW9yaWdpbiwKICAgICAgICAgICAgc2NhbGU9KDIuMCBpZiB1aXNjYWxlIGlzIGJhLlVJU2NhbGUuU01BTEwgZWxzZQogICAgICAgICAgICAgICAgICAgMS4zNSBpZiB1aXNjYWxlIGlzIGJhLlVJU2NhbGUuTUVESVVNIGVsc2UgMS4wKSwKICAgICAgICAgICAgc3RhY2tfb2Zmc2V0PSgwLCAtMTApIGlmIHVpc2NhbGUgaXMgYmEuVUlTY2FsZS5TTUFMTCBlbHNlICgKICAgICAgICAgICAgICAgIDI0MCwgMCkgaWYgdWlzY2FsZSBpcyBiYS5VSVNjYWxlLk1FRElVTSBlbHNlICgzMzAsIDIwKSkpCgogICAgICAgIHNlbGYuX2NhbmNlbF9idXR0b24gPSBiYS5idXR0b253aWRnZXQocGFyZW50PXNlbGYuX3Jvb3Rfd2lkZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU9MC43LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb249KDMwLCBzZWxmLl9oZWlnaHQgLSA0NyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPSg1MCwgNTApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw9JycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbl9hY3RpdmF0ZV9jYWxsPXNlbGYuY2xvc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRvc2VsZWN0PVRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcj0oMC40NSwgMC42MywgMC4xNSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uPWJhLmdldHRleHR1cmUoJ2Nyb3NzT3V0JyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uc2NhbGU9MS4yKQogICAgICAgIHNlbGYuX3Ntb290aHlfYnV0dG9uID0gYmEuYnV0dG9ud2lkZ2V0KHBhcmVudD1zZWxmLl9yb290X3dpZGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlPTAuNiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uPSg1LCBzZWxmLl9oZWlnaHQgLSA0NyAtNDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT0oNTAsIDUwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsPSc2OScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbl9hY3RpdmF0ZV9jYWxsPXNlbGYuc21vb3RoeV9yb3N0ZXJfY2hhbmdlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9zZWxlY3Q9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yPSgwLjQ1LCAwLjYzLCAwLjE1KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGljb249YmEuZ2V0dGV4dHVyZSgncmVwbGF5SWNvbicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWNvbnNjYWxlPTEuMikKICAgICAgICBiYS5jb250YWluZXJ3aWRnZXQoZWRpdD1zZWxmLl9yb290X3dpZGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuY2VsX2J1dHRvbj1zZWxmLl9jYW5jZWxfYnV0dG9uKQoKICAgICAgICBzZWxmLl9tZW51X2J1dHRvbiA9IGJhLmJ1dHRvbndpZGdldCgKICAgICAgICAgICAgcGFyZW50PXNlbGYuX3Jvb3Rfd2lkZ2V0LAogICAgICAgICAgICBzY2FsZT0wLjcsCiAgICAgICAgICAgIHBvc2l0aW9uPShzZWxmLl93aWR0aCAtIDYwLCBzZWxmLl9oZWlnaHQgLSA0NyksCiAgICAgICAgICAgIHNpemU9KDUwLCA1MCksCiAgICAgICAgICAgIGxhYmVsPSJceGVlXHg4MFx4OTAiLAogICAgICAgICAgICBhdXRvc2VsZWN0PVRydWUsCiAgICAgICAgICAgIGJ1dHRvbl90eXBlPSdzcXVhcmUnLAogICAgICAgICAgICBvbl9hY3RpdmF0ZV9jYWxsPWJhLldlYWtDYWxsKHNlbGYuX29uX21lbnVfYnV0dG9uX3ByZXNzKSwKICAgICAgICAgICAgY29sb3I9KDAuNTUsIDAuNzMsIDAuMjUpLAogICAgICAgICAgICBpY29uPWJhLmdldHRleHR1cmUoJ21lbnVCdXR0b24nKSwKICAgICAgICAgICAgaWNvbnNjYWxlPTEuMikKCiAgICAgICAgaW5mbyA9IF9iYS5nZXRfY29ubmVjdGlvbl90b19ob3N0X2luZm8oKQogICAgICAgIGlmIGluZm8uZ2V0KCduYW1lJywgJycpICE9ICcnOgogICAgICAgICAgICB0aXRsZSA9IGluZm9bJ25hbWUnXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRpdGxlID0gYmEuTHN0cihyZXNvdXJjZT1zZWxmLl9yICsgJy50aXRsZVRleHQnKQoKICAgICAgICBzZWxmLl90aXRsZV90ZXh0ID0gYmEudGV4dHdpZGdldChwYXJlbnQ9c2VsZi5fcm9vdF93aWRnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU9MC45LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yPSgwLjUsIDAuNywgMC41KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0PXRpdGxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU9KDEyMCwgMjApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uPShzZWxmLl93aWR0aCAqIDAuNS02MCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5faGVpZ2h0IC0gMjkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uX3NlbGVjdF9jYWxsPXNlbGYudGl0bGVfc2VsZWN0ZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZT1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heHdpZHRoPXNlbGYuX3dpZHRoICogMC43LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhfYWxpZ249J2NlbnRlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdl9hbGlnbj0nY2VudGVyJykKCiAgICAgICAgc2VsZi5fZW1wdHlfc3RyID0gYmEudGV4dHdpZGdldChwYXJlbnQ9c2VsZi5fcm9vdF93aWRnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZT0wLjc1LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT0oMCwgMCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbj0oc2VsZi5fd2lkdGggKiAwLjUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5faGVpZ2h0IC0gNjUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4d2lkdGg9c2VsZi5fd2lkdGggKiAwLjg1LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dD0ibm8gb25lIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhfYWxpZ249J2NlbnRlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2X2FsaWduPSdjZW50ZXInKQoKICAgICAgICBzZWxmLl9zY3JvbGxfd2lkdGggPSBzZWxmLl93aWR0aCAtIDUwCiAgICAgICAgc2VsZi5fc2Nyb2xsd2lkZ2V0ID0gYmEuc2Nyb2xsd2lkZ2V0KHBhcmVudD1zZWxmLl9yb290X3dpZGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT0oc2VsZi5fc2Nyb2xsX3dpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9oZWlnaHQgLSAyMDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbj0oMzAsIDgwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I9KDAuNCwgMC42LCAwLjMpKQogICAgICAgIHNlbGYuX2NvbHVtbndpZGdldCA9IGJhLmNvbHVtbndpZGdldChwYXJlbnQ9c2VsZi5fc2Nyb2xsd2lkZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI9MiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2luPTApCiAgICAgICAgYmEud2lkZ2V0KGVkaXQ9c2VsZi5fbWVudV9idXR0b24sIGRvd25fd2lkZ2V0PXNlbGYuX2NvbHVtbndpZGdldCkKCiAgICAgICAgc2VsZi5fbXV0ZWRfdGV4dCA9IGJhLnRleHR3aWRnZXQoCiAgICAgICAgICAgIHBhcmVudD1zZWxmLl9yb290X3dpZGdldCwKICAgICAgICAgICAgcG9zaXRpb249KHNlbGYuX3dpZHRoICogMC41LCBzZWxmLl9oZWlnaHQgKiAwLjUpLAogICAgICAgICAgICBzaXplPSgwLCAwKSwKICAgICAgICAgICAgaF9hbGlnbj0nY2VudGVyJywKICAgICAgICAgICAgdl9hbGlnbj0nY2VudGVyJywKICAgICAgICAgICAgdGV4dD0iIikKICAgICAgICBzZWxmLl9jaGF0X3RleHRzOiBMaXN0W2JhLldpZGdldF0gPSBbXQogICAgICAgIHNlbGYuX2NoYXRfdGV4dHNfaGF4eDogTGlzdFtiYS5XaWRnZXRdID0gW10KCiAgICAgICAgIyBhZGQgYWxsIGV4aXN0aW5nIG1lc3NhZ2VzIGlmIGNoYXQgaXMgbm90IG11dGVkCiAgICAgICAgIyBwcmludCgidXBkYXRlcyIpCiAgICAgICAgaWYgVHJ1ZTogICAjc21vb3RoeSAtIGFsd2F5cyBzaG93IGNoYXQgaW4gcGFydHl3aW5kb3cKICAgICAgICAgICAgbXNncyA9IF9iYS5nZXRfY2hhdF9tZXNzYWdlcygpCiAgICAgICAgICAgIGZvciBtc2cgaW4gbXNnczoKICAgICAgICAgICAgICAgIHNlbGYuX2FkZF9tc2cobXNnKQogICAgICAgICAgICAgICAgIyBwcmludChtc2cpCiAgICAgICAgIyBlbHNlOgogICAgICAgICMgICBtc2dzPV9iYS5nZXRfY2hhdF9tZXNzYWdlcygpCiAgICAgICAgIyAgIGZvciBtc2cgaW4gbXNnczoKICAgICAgICAjICAgICBwcmludChtc2cpOwogICAgICAgICMgICAgIHR4dCA9IGJhLnRleHR3aWRnZXQocGFyZW50PXNlbGYuX2NvbHVtbndpZGdldCwKICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ9bXNnLAogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgaF9hbGlnbj0nbGVmdCcsCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICB2X2FsaWduPSdjZW50ZXInLAogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT0oMCwgMTMpLAogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU9MC41NSwKICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICAgIG1heHdpZHRoPXNlbGYuX3Njcm9sbF93aWR0aCAqIDAuOTQsCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICBzaGFkb3c9MC4zLAogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgZmxhdG5lc3M9MS4wKQogICAgICAgICAgICAjIHNlbGYuX2NoYXRfdGV4dHMuYXBwZW5kKHR4dCkKICAgICAgICAgICAgIyBpZiBsZW4oc2VsZi5fY2hhdF90ZXh0cykgPiA0MDoKICAgICAgICAgICAgIyAgICAgZmlyc3QgPSBzZWxmLl9jaGF0X3RleHRzLnBvcCgwKQogICAgICAgICAgICAjICAgICBmaXJzdC5kZWxldGUoKQogICAgICAgICAgICAjIGJhLmNvbnRhaW5lcndpZGdldChlZGl0PXNlbGYuX2NvbHVtbndpZGdldCwgdmlzaWJsZV9jaGlsZD10eHQpCiAgICAgICAgc2VsZi5fdGV4dF9maWVsZCA9IHR4dCA9IGJhLnRleHR3aWRnZXQoCiAgICAgICAgICAgIHBhcmVudD1zZWxmLl9yb290X3dpZGdldCwKICAgICAgICAgICAgZWRpdGFibGU9VHJ1ZSwKICAgICAgICAgICAgc2l6ZT0oNTMwLTgwLCA0MCksCiAgICAgICAgICAgIHBvc2l0aW9uPSg0NCs2MCwgMzkpLAogICAgICAgICAgICB0ZXh0PScnLAogICAgICAgICAgICBtYXh3aWR0aD00OTQsCiAgICAgICAgICAgIHNoYWRvdz0wLjMsCiAgICAgICAgICAgIGZsYXRuZXNzPTEuMCwKICAgICAgICAgICAgZGVzY3JpcHRpb249YmEuTHN0cihyZXNvdXJjZT1zZWxmLl9yICsgJy5jaGF0TWVzc2FnZVRleHQnKSwKICAgICAgICAgICAgYXV0b3NlbGVjdD1UcnVlLAogICAgICAgICAgICB2X2FsaWduPSdjZW50ZXInLAogICAgICAgICAgICBjb3JuZXJfc2NhbGU9MC43KQogICAgICAgICMgZm9yIG0gaW4gIF9iYS5nZXRfY2hhdF9tZXNzYWdlcygpOgogICAgICAgICMgICBpZiBtOgogICAgICAgICMgICAgIHR0Y2hhdD1iYS50ZXh0d2lkZ2V0KAogICAgICAgICMgICAgICAgICAgICAgICBwYXJlbnQ9c2VsZi5fY29sdW1ud2lkZ2V0LAogICAgICAgICMgICAgICAgICAgICAgICBzaXplPSgxMCwxMCksCiAgICAgICAgIyAgICAgICAgICAgICAgIGhfYWxpZ249J2xlZnQnLAogICAgICAgICMgICAgICAgICAgICAgICB2X2FsaWduPSdjZW50ZXInLAogICAgICAgICMgICAgICAgICAgICAgICB0ZXh0PXN0cihtKSwKICAgICAgICAjICAgICAgICAgICAgICAgc2NhbGU9MC42LAogICAgICAgICMgICAgICAgICAgICAgICBmbGF0bmVzcz0wLAogICAgICAgICMgICAgICAgICAgICAgICBjb2xvcj0oMiwyLDIpLAogICAgICAgICMgICAgICAgICAgICAgICBzaGFkb3c9MCwKICAgICAgICAjICAgICAgICAgICAgICAgYWx3YXlzX2hpZ2hsaWdodD1UcnVlCgogICAgICAgICMgICAgICAgICAgICAgICApCiAgICAgICAgYmEud2lkZ2V0KGVkaXQ9c2VsZi5fc2Nyb2xsd2lkZ2V0LAogICAgICAgICAgICAgICAgICBhdXRvc2VsZWN0PVRydWUsCiAgICAgICAgICAgICAgICAgIGxlZnRfd2lkZ2V0PXNlbGYuX2NhbmNlbF9idXR0b24sCiAgICAgICAgICAgICAgICAgIHVwX3dpZGdldD1zZWxmLl9jYW5jZWxfYnV0dG9uLAogICAgICAgICAgICAgICAgICBkb3duX3dpZGdldD1zZWxmLl90ZXh0X2ZpZWxkKQogICAgICAgIGJhLndpZGdldChlZGl0PXNlbGYuX2NvbHVtbndpZGdldCwKICAgICAgICAgICAgICAgICAgYXV0b3NlbGVjdD1UcnVlLAogICAgICAgICAgICAgICAgICB1cF93aWRnZXQ9c2VsZi5fY2FuY2VsX2J1dHRvbiwKICAgICAgICAgICAgICAgICAgZG93bl93aWRnZXQ9c2VsZi5fdGV4dF9maWVsZCkKICAgICAgICBiYS5jb250YWluZXJ3aWRnZXQoZWRpdD1zZWxmLl9yb290X3dpZGdldCwgc2VsZWN0ZWRfY2hpbGQ9dHh0KQogICAgICAgIGJ0biA9IGJhLmJ1dHRvbndpZGdldChwYXJlbnQ9c2VsZi5fcm9vdF93aWRnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU9KDUwLCAzNSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsPWJhLkxzdHIocmVzb3VyY2U9c2VsZi5fciArICcuc2VuZFRleHQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uX3R5cGU9J3NxdWFyZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9zZWxlY3Q9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb249KHNlbGYuX3dpZHRoIC0gNzAsIDM1KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25fYWN0aXZhdGVfY2FsbD1zZWxmLl9zZW5kX2NoYXRfbWVzc2FnZSkKICAgIAoKCiAgICAgICAgZGVmIF90aW1lc19idXR0b25fb25fY2xpY2soKToKICAgICAgICAgICAgIyBzZWxmLl9wb3B1cF90eXBlID0gInNlbmRfVGltZXNfUHJlc3MiCiAgICAgICAgICAgICMgYWxsb3dfcmFuZ2UgPSAxMDAgaWYgX2JhLmdldF9mb3JlZ3JvdW5kX2hvc3Rfc2Vzc2lvbigpIGlzIG5vdCBOb25lIGVsc2UgNAogICAgICAgICAgICAjIFBvcHVwTWVudVdpbmRvdyhwb3NpdGlvbj1zZWxmLl90aW1lc19idXR0b24uZ2V0X3NjcmVlbl9zcGFjZV9jZW50ZXIoKSwKICAgICAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU9X2dldF9wb3B1cF93aW5kb3dfc2NhbGUoKSwKICAgICAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlcz1bc3RyKGluZGV4KSBmb3IgaW5kZXggaW4gcmFuZ2UoMSxhbGxvd19yYW5nZSArIDEpXSwKICAgICAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlc19kaXNwbGF5PV9jcmVhdF9Mc3RyX2xpc3QoW19nZXRUcmFuc1RleHQoIlNlbmRfJWRfdGltZXMiKSVpbnQoaW5kZXgpIGZvciBpbmRleCBpbiByYW5nZSgxLGFsbG93X3JhbmdlICsgMSldKSwKICAgICAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9jaG9pY2U9IlNoYXJlX1NlcnZlcl9JbmZvIiwKICAgICAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZWdhdGU9c2VsZikKICAgICAgICAgICAgUXVpY2tyZXBseSA9IHNlbGYuX2dldF9xdWlja19yZXNwb25kcygpCiAgICAgICAgICAgIGlmIGxlbihRdWlja3JlcGx5KSA+IDA6CiAgICAgICAgICAgICAgICBQb3B1cE1lbnVXaW5kb3cocG9zaXRpb249c2VsZi5fdGltZXNfYnV0dG9uLmdldF9zY3JlZW5fc3BhY2VfY2VudGVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU9X2dldF9wb3B1cF93aW5kb3dfc2NhbGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2VzPVF1aWNrcmVwbHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlc19kaXNwbGF5PV9jcmVhdF9Mc3RyX2xpc3QoUXVpY2tyZXBseSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9jaG9pY2U9UXVpY2tyZXBseVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxlZ2F0ZT1zZWxmKQogICAgICAgICAgICAgICAgc2VsZi5fcG9wdXBfdHlwZSA9ICJRdWlja01lc3NhZ2VTZWxlY3QiCiAgICAgICAgCiAgICAgICAgc2VsZi5fc2VuZF9tc2dfdGltZXMgPSAxCiAgICAgICAgCiAgICAgICAgc2VsZi5fdGltZXNfYnV0dG9uID0gYmEuYnV0dG9ud2lkZ2V0KHBhcmVudD1zZWxmLl9yb290X3dpZGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU9KDUwLCAzNSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD0iUXVpY2siLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uX3R5cGU9J3NxdWFyZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRvc2VsZWN0PVRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbj0oMzAsIDM1KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uX2FjdGl2YXRlX2NhbGw9X3RpbWVzX2J1dHRvbl9vbl9jbGljaykKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICBiYS50ZXh0d2lkZ2V0KGVkaXQ9dHh0LCBvbl9yZXR1cm5fcHJlc3NfY2FsbD1idG4uYWN0aXZhdGUpCiAgICAgICAgc2VsZi5fbmFtZV93aWRnZXRzOiBMaXN0W2JhLldpZGdldF0gPSBbXQogICAgICAgIHNlbGYuX3Jvc3RlcjogT3B0aW9uYWxbTGlzdFtEaWN0W3N0ciwgQW55XV1dID0gTm9uZQoKICAgICAgICBzZWxmLnNtb290aHlfbW9kZT0xCiAgICAgICAgc2VsZi5mdWxsX2NoYXRfbW9kZT1GYWxzZQogICAgICAgIHNlbGYuX3VwZGF0ZV90aW1lciA9IGJhLlRpbWVyKDEuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYS5XZWFrQ2FsbChzZWxmLl91cGRhdGUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGVhdD1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWV0eXBlPWJhLlRpbWVUeXBlLlJFQUwpCgogICAgICAgIHNlbGYuX3VwZGF0ZSgpCiAgICBkZWYgdGl0bGVfc2VsZWN0ZWQoc2VsZik6CiAgICAgICAgCiAgICAgICAgc2VsZi5mdWxsX2NoYXRfbW9kZT0gc2VsZi5mdWxsX2NoYXRfbW9kZSA9PUZhbHNlCiAgICAgICAgc2VsZi5fdXBkYXRlKCkKICAgIGRlZiBzbW9vdGh5X3Jvc3Rlcl9jaGFuZ2VyKHNlbGYpOgogICAgICAKICAgICAgc2VsZi5zbW9vdGh5X21vZGU9KHNlbGYuc21vb3RoeV9tb2RlKzEpJTMKCiAgICAgIAogICAgICAKICAgICAgc2VsZi5fdXBkYXRlKCkKCiAgICBkZWYgb25fY2hhdF9tZXNzYWdlKHNlbGYsIG1zZzogc3RyKSAtPiBOb25lOgoKICAgICAgICAgICAgIiIiQ2FsbGVkIHdoZW4gYSBuZXcgY2hhdCBtZXNzYWdlIGNvbWVzIHRocm91Z2guIiIiCiAgICAgICAgICAgICMgcHJpbnQoIm9uX2NoYXQiK21zZykKICAgICAgICAgICAgaWYgVHJ1ZToKICAgICAgICAgICAgICAgIHNlbGYuX2FkZF9tc2cobXNnKQogICAgZGVmIF9vbl9jaGF0X3ByZXNzKHNlbGYsbXNnLHdpZGdldCk6CiAgICAgICAgZ2xvYmFsIHVubXV0ZWRfbmFtZXMKICAgICAgICBwcmludCgiY2hhdCBwcmVzc2VkIikKICAgICAgICBpZiBtc2cuc3BsaXQoIjoiKVswXSBpbiB1bm11dGVkX25hbWVzOgoKICAgICAgICAgICAgY2hvaWNlcz1bJ211dGUnXQogICAgICAgICAgICBjaG9pY2VzX2Rpc3BsYXk9W19nZXRUcmFuc1RleHQoIm11dGV0aGlzZ3V5Iixpc0JhTHN0ciA9IFRydWUpXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNob2ljZXM9Wyd1bm11dGUnXQogICAgICAgICAgICBjaG9pY2VzX2Rpc3BsYXk9W19nZXRUcmFuc1RleHQoInVubXV0ZXRoaXNndXkiLGlzQmFMc3RyID0gVHJ1ZSldCiAgICAgICAgUG9wdXBNZW51V2luZG93KHBvc2l0aW9uPXdpZGdldC5nZXRfc2NyZWVuX3NwYWNlX2NlbnRlcigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU9X2dldF9wb3B1cF93aW5kb3dfc2NhbGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXM9Y2hvaWNlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXNfZGlzcGxheT1jaG9pY2VzX2Rpc3BsYXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2Nob2ljZT0iQCB0aGlzIGd1eSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxlZ2F0ZT1zZWxmKQogICAgICAgIHNlbGYubXNnX3VzZXJfc2VsZWN0ZWQ9bXNnLnNwbGl0KCI6IilbMF0KICAgICAgICBzZWxmLl9wb3B1cF90eXBlID0gImNoYXRtZXNzYWdlcHJlc3MiCgogICAgICAgICMgX2JhLmNoYXRtZXNzYWdlKCJwcmVzc2VkIikKCgogICAgZGVmIF9hZGRfbXNnKHNlbGYsIG1zZzogc3RyKSAtPiBOb25lOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBiYS5hcHAuY29uZmlnLnJlc29sdmUoJ0NoYXQgTXV0ZWQnKToKCgogICAgICAgICAgICAgICAgICAgIHR4dCA9IGJhLnRleHR3aWRnZXQocGFyZW50PXNlbGYuX2NvbHVtbndpZGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ9bXNnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaF9hbGlnbj0nbGVmdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2X2FsaWduPSdjZW50ZXInLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT0oMTMwLCAxMyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZT0wLjU1LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb249KC0wLjYsMCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RhYmxlPVRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGlja19hY3RpdmF0ZT1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4d2lkdGg9c2VsZi5fc2Nyb2xsX3dpZHRoICogMC45NCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRvdz0wLjMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGF0bmVzcz0xLjApCiAgICAgICAgICAgICAgICAgICAgYmEudGV4dHdpZGdldChlZGl0PXR4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbl9hY3RpdmF0ZV9jYWxsPWJhLkNhbGwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX29uX2NoYXRfcHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZyx0eHQpKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB0eHQgPSBiYS50ZXh0d2lkZ2V0KHBhcmVudD1zZWxmLl9jb2x1bW53aWRnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0PW1zZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhfYWxpZ249J2xlZnQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdl9hbGlnbj0nY2VudGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU9KDAsIDEzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlPTAuNTUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXh3aWR0aD1zZWxmLl9zY3JvbGxfd2lkdGggKiAwLjk0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhZG93PTAuMywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXRuZXNzPTEuMCkKCiAgICAgICAgICAgICAgIyBidG4gPSBiYS5idXR0b253aWRnZXQocGFyZW50PXNlbGYuX2NvbHVtbndpZGdldCwKICAgICAgICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICBzY2FsZT0wLjcsCiAgICAgICAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT0oMTAwLDIwKSwKICAgICAgICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD0ic21vb3RoeSBidXR0aW4iLAogICAgICAgICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgIGljb249YmEuZ2V0dGV4dHVyZSgncmVwbGF5SWNvbicpLAogICAgICAgICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgIHRleHR1cmU9Tm9uZSwKICAgICAgICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBzZWxmLl9jaGF0X3RleHRzX2hheHguYXBwZW5kKHR4dCkKICAgICAgICAgICAgICAgIGlmIGxlbihzZWxmLl9jaGF0X3RleHRzX2hheHgpID4gNDA6CiAgICAgICAgICAgICAgICAgICAgZmlyc3QgPSBzZWxmLl9jaGF0X3RleHRzX2hheHgucG9wKDApCiAgICAgICAgICAgICAgICAgICAgZmlyc3QuZGVsZXRlKCkKICAgICAgICAgICAgICAgIGJhLmNvbnRhaW5lcndpZGdldChlZGl0PXNlbGYuX2NvbHVtbndpZGdldCwgdmlzaWJsZV9jaGlsZD10eHQpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgIGRlZiBfYWRkX21zZ193aGVuX211dGVkKHNlbGYsIG1zZzogc3RyKSAtPiBOb25lOgoKICAgICAgICAgICAgdHh0ID0gYmEudGV4dHdpZGdldChwYXJlbnQ9c2VsZi5fY29sdW1ud2lkZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ9bXNnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhfYWxpZ249J2xlZnQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZfYWxpZ249J2NlbnRlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT0oMCwgMTMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlPTAuNTUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4d2lkdGg9c2VsZi5fc2Nyb2xsX3dpZHRoICogMC45NCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFkb3c9MC4zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXRuZXNzPTEuMCkKICAgICAgICAgICAgc2VsZi5fY2hhdF90ZXh0cy5hcHBlbmQodHh0KQogICAgICAgICAgICBpZiBsZW4oc2VsZi5fY2hhdF90ZXh0cykgPiA0MDoKICAgICAgICAgICAgICAgIGZpcnN0ID0gc2VsZi5fY2hhdF90ZXh0cy5wb3AoMCkKICAgICAgICAgICAgICAgIGZpcnN0LmRlbGV0ZSgpCiAgICAgICAgICAgIGJhLmNvbnRhaW5lcndpZGdldChlZGl0PXNlbGYuX2NvbHVtbndpZGdldCwgdmlzaWJsZV9jaGlsZD10eHQpCiAgICBkZWYgY29sb3JfcGlja2VyX2Nsb3Npbmcoc2VsZiwgcGlja2VyKSAtPiBOb25lOgogICAgICAgIGJhLl9hcHBjb25maWcuY29tbWl0X2FwcF9jb25maWcoKQogICAgZGVmIGNvbG9yX3BpY2tlcl9zZWxlY3RlZF9jb2xvcihzZWxmLCBwaWNrZXIsIGNvbG9yKSAtPiBOb25lOgogICAgICAgICNicy5hbmltYXRlQXJyYXkoc2VsZi5fcm9vdF93aWRnZXQsImNvbG9yIiwzLHswOnNlbGYuX2JnX2NvbG9yLDE1MDA6Y29sb3J9KQogICAgICAgIGJhLmNvbnRhaW5lcndpZGdldChlZGl0PXNlbGYuX3Jvb3Rfd2lkZ2V0LGNvbG9yPWNvbG9yKQogICAgICAgIHNlbGYuX2JnX2NvbG9yID0gY29sb3IKICAgICAgICBiYS5hcHAuY29uZmlnWyJQYXJ0eVdpbmRvd19NYWluX0NvbG9yIl0gPSBjb2xvcgogICAgZGVmIF9vbl9uaWNrX3JlbmFtZV9wcmVzcyhzZWxmLGFyZykgLT4gTm9uZToKICAgICAgICAKICAgICAgICBiYS5jb250YWluZXJ3aWRnZXQoZWRpdD1zZWxmLl9yb290X3dpZGdldCwgdHJhbnNpdGlvbj0nb3V0X3NjYWxlJykKICAgICAgICBjX3dpZHRoID0gNjAwCiAgICAgICAgY19oZWlnaHQgPSAyNTAKICAgICAgICB1aXNjYWxlID0gYmEuYXBwLnVpLnVpc2NhbGUKICAgICAgICBzZWxmLl9uaWNrX3JlbmFtZV93aW5kb3cgPSBjbnQgPSBiYS5jb250YWluZXJ3aWRnZXQoCiAgICAgICAgICAgIAogICAgICAgICAgICBzY2FsZT0oMS44IGlmIHVpc2NhbGUgaXMgYmEuVUlTY2FsZS5TTUFMTCBlbHNlCiAgICAgICAgICAgICAgICAgICAxLjU1IGlmIHVpc2NhbGUgaXMgYmEuVUlTY2FsZS5NRURJVU0gZWxzZSAxLjApLAogICAgICAgICAgICBzaXplPShjX3dpZHRoLCBjX2hlaWdodCksCiAgICAgICAgICAgIHRyYW5zaXRpb249J2luX3NjYWxlJykKCiAgICAgICAgYmEudGV4dHdpZGdldChwYXJlbnQ9Y250LAogICAgICAgICAgICAgICAgICAgICAgc2l6ZT0oMCwgMCksCiAgICAgICAgICAgICAgICAgICAgICBoX2FsaWduPSdjZW50ZXInLAogICAgICAgICAgICAgICAgICAgICAgdl9hbGlnbj0nY2VudGVyJywKICAgICAgICAgICAgICAgICAgICAgIHRleHQ9J0VudGVyIG5pY2tuYW1lJywKICAgICAgICAgICAgICAgICAgICAgIG1heHdpZHRoPWNfd2lkdGggKiAwLjgsCiAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbj0oY193aWR0aCAqIDAuNSwgY19oZWlnaHQgLSA2MCkpCiAgICAgICAgaWQ9c2VsZi5fZ2V0X25pY2soYXJnKQogICAgICAgIHNlbGYuX3BsYXllcl9uaWNrX3RleHQgPSB0eHQ4OSA9IGJhLnRleHR3aWRnZXQoCiAgICAgICAgICAgIHBhcmVudD1jbnQsCiAgICAgICAgICAgIHNpemU9KGNfd2lkdGggKiAwLjgsIDQwKSwKICAgICAgICAgICAgaF9hbGlnbj0nbGVmdCcsCiAgICAgICAgICAgIHZfYWxpZ249J2NlbnRlcicsCiAgICAgICAgICAgIHRleHQ9aWQsCiAgICAgICAgICAgIGVkaXRhYmxlPVRydWUsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSdQbGF5ZXJzIG5pY2sgbmFtZScsCiAgICAgICAgICAgIHBvc2l0aW9uPShjX3dpZHRoICogMC4xLCBjX2hlaWdodCAtIDE0MCksCiAgICAgICAgICAgIGF1dG9zZWxlY3Q9VHJ1ZSwKICAgICAgICAgICAgbWF4d2lkdGg9Y193aWR0aCAqIDAuNywKICAgICAgICAgICAgbWF4X2NoYXJzPTIwMCkKICAgICAgICBjYnRuID0gYmEuYnV0dG9ud2lkZ2V0KAogICAgICAgICAgICBwYXJlbnQ9Y250LAogICAgICAgICAgICBsYWJlbD1iYS5Mc3RyKHJlc291cmNlPSdjYW5jZWxUZXh0JyksCiAgICAgICAgICAgIG9uX2FjdGl2YXRlX2NhbGw9YmEuQ2FsbCgKICAgICAgICAgICAgICAgIGxhbWJkYSBjOiBiYS5jb250YWluZXJ3aWRnZXQoZWRpdD1jLCB0cmFuc2l0aW9uPSdvdXRfc2NhbGUnKSwKICAgICAgICAgICAgICAgIGNudCksCiAgICAgICAgICAgIHNpemU9KDE4MCwgNjApLAogICAgICAgICAgICBwb3NpdGlvbj0oMzAsIDMwKSwKICAgICAgICAgICAgYXV0b3NlbGVjdD1UcnVlKQogICAgICAgIG9rYiA9IGJhLmJ1dHRvbndpZGdldChwYXJlbnQ9Y250LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD0nUmVuYW1lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZT0oMTgwLCA2MCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uPShjX3dpZHRoIC0gMjMwLCAzMCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uX2FjdGl2YXRlX2NhbGw9YmEuQ2FsbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2FkZF9uaWNrLGFyZyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9zZWxlY3Q9VHJ1ZSkKICAgICAgICBiYS53aWRnZXQoZWRpdD1jYnRuLCByaWdodF93aWRnZXQ9b2tiKQogICAgICAgIGJhLndpZGdldChlZGl0PW9rYiwgbGVmdF93aWRnZXQ9Y2J0bikKICAgICAgICBiYS50ZXh0d2lkZ2V0KGVkaXQ9dHh0ODksIG9uX3JldHVybl9wcmVzc19jYWxsPW9rYi5hY3RpdmF0ZSkKICAgICAgICBiYS5jb250YWluZXJ3aWRnZXQoZWRpdD1jbnQsIGNhbmNlbF9idXR0b249Y2J0biwgc3RhcnRfYnV0dG9uPW9rYikKICAgIGRlZiBfYWRkX25pY2soc2VsZixhcmcpOgogICAgICBjb25maWcgPSBiYS5hcHAuY29uZmlnCiAgICAgIG5ld19uYW1lX3JhdyA9IGNhc3Qoc3RyLCBiYS50ZXh0d2lkZ2V0KHF1ZXJ5PXNlbGYuX3BsYXllcl9uaWNrX3RleHQpKQogICAgICBpZiBhcmc6CiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoY29uZmlnLmdldCgncGxheWVycyBuaWNrJyksIGRpY3QpOgogICAgICAgICAgICBjb25maWdbJ3BsYXllcnMgbmljayddID0ge30KICAgICAgICBjb25maWdbJ3BsYXllcnMgbmljayddW2FyZ10gPSBuZXdfbmFtZV9yYXcKICAgICAgICBjb25maWcuY29tbWl0KCkKICAgICAgYmEuY29udGFpbmVyd2lkZ2V0KGVkaXQ9c2VsZi5fbmlja19yZW5hbWVfd2luZG93LAogICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uPSdvdXRfc2NhbGUnKQogICAgICAjIGJhLmNvbnRhaW5lcndpZGdldChlZGl0PXNlbGYuX3Jvb3Rfd2lkZ2V0LHRyYW5zaXRpb249J2luX3NjYWxlJykKICAgIGRlZiBfZ2V0X25pY2soc2VsZixpZCk6CiAgICAgIGNvbmZpZz1iYS5hcHAuY29uZmlnCiAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGNvbmZpZy5nZXQoJ3BsYXllcnMgbmljaycpLCBkaWN0KToKICAgICAgICAgICAgcmV0dXJuICJhZGQgbmljayIKICAgICAgZWxpZiBpZCBpbiBjb25maWdbJ3BsYXllcnMgbmljayddOgogICAgICAgIHJldHVybiBjb25maWdbJ3BsYXllcnMgbmljayddW2lkXQogICAgICBlbHNlOgogICAgICAgIHJldHVybiAiYWRkIG5pY2siCgogICAgZGVmIF9yZXNldF9nYW1lX3JlY29yZChzZWxmKSAtPiBOb25lOgogICAgICAgIHRyeToKICAgICAgICAgICAgZGlyX3BhdGggPSBfYmEuZ2V0X3JlcGxheXNfZGlyKCk7Y3VyRmlsZVBhdGggPSBvcy5wYXRoLmpvaW4oZGlyX3BhdGgrb3Muc2VwLCJfX2xhc3RSZXBsYXkuYnJwIikuZW5jb2RlKFN5c3RlbUVuY29kZSkKICAgICAgICAgICAgbmV3RmlsZU5hbWUgPSBzdHIoYmEuTHN0cihyZXNvdXJjZT0icmVwbGF5TmFtZURlZmF1bHRUZXh0IikuZXZhbHVhdGUoKSsiICglcykiJShkYXRldGltZS5kYXRldGltZS5zdHJmdGltZShkYXRldGltZS5kYXRldGltZS5ub3coKSwiJVlfJW1fJWRfJUhfJU1fJVMiKSkrIi5icnAiKQogICAgICAgICAgICBuZXdGaWxlUGF0aCA9IG9zLnBhdGguam9pbihkaXJfcGF0aCtvcy5zZXAsbmV3RmlsZU5hbWUpLmVuY29kZShTeXN0ZW1FbmNvZGUpCiAgICAgICAgICAgICNwcmludChjdXJGaWxlUGF0aCwgbmV3RmlsZVBhdGgpCiAgICAgICAgICAgICNvcy5yZW5hbWUoY3VyRmlsZVBhdGgsbmV3RmlsZVBhdGgpCiAgICAgICAgICAgIHNodXRpbC5jb3B5ZmlsZShjdXJGaWxlUGF0aCwgbmV3RmlsZVBhdGgpCiAgICAgICAgICAgIF9iYS5yZXNldF9nYW1lX2FjdGl2aXR5X3RyYWNraW5nKCkKICAgICAgICAgICAgYmEuc2NyZWVubWVzc2FnZShfZ2V0VHJhbnNUZXh0KCJHYW1lX1JlY29yZF9TYXZlZCIpJW5ld0ZpbGVOYW1lLGNvbG9yID0gKDEsMSwxKSkKICAgICAgICBleGNlcHQ6YmEucHJpbnRfZXhjZXB0aW9uKCk7YmEuc2NyZWVubWVzc2FnZShiYS5Mc3RyKHJlc291cmNlPSJyZXBsYXlXcml0ZUVycm9yVGV4dCIpLmV2YWx1YXRlKCkrIlwKIit0cmFjZWJhY2suZm9ybWF0X2V4YygpLGNvbG9yID0gKDEsMCwwKSkKICAgIGRlZiBfb25fbWVudV9idXR0b25fcHJlc3Moc2VsZikgLT4gTm9uZToKICAgICAgICBpc19tdXRlZCA9IGJhLmFwcC5jb25maWcucmVzb2x2ZSgnQ2hhdCBNdXRlZCcpCiAgICAgICAgZ2xvYmFsIGNoYXRsb2dnZXIKICAgICAgICBjaG9pY2VzID0gWyJ1bm11dGUiIGlmIGlzX211dGVkIGVsc2UgIm11dGUiLCJzY3JlZW5tc2ciLCJhZGRRdWlja1JlcGx5IiwicmVtb3ZlUXVpY2tSZXBseSIsImNoYXRsb2dnZXIiLCJjcmVkaXRzIl0KICAgICAgICBEaXNDaG9pY2VzID0gW19nZXRUcmFuc1RleHQoInVubXV0ZWFsbCIsaXNCYUxzdHIgPSBUcnVlKSBpZiBpc19tdXRlZCBlbHNlIF9nZXRUcmFuc1RleHQoIm11dGVhbGwiLGlzQmFMc3RyID0gVHJ1ZSksCiAgICAgICAgICAgICAgICBfZ2V0VHJhbnNUZXh0KCJzY3JlZW5tc2dvZmYiLGlzQmFMc3RyID0gVHJ1ZSkgaWYgc2NyZWVubXNnIGVsc2UgX2dldFRyYW5zVGV4dCgic2NyZWVubXNnb24iLGlzQmFMc3RyID0gVHJ1ZSksCiAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX2dldFRyYW5zVGV4dCgiQWRkX2FfUXVpY2tfUmVwbHkiLGlzQmFMc3RyID0gVHJ1ZSksCiAgICAgICAgICAgICAgICBfZ2V0VHJhbnNUZXh0KCJSZW1vdmVfYV9RdWlja19SZXBseSIsaXNCYUxzdHIgPSBUcnVlKSwKICAgICAgICAgICAgICAgIF9nZXRUcmFuc1RleHQoImNoYXRsb2dnZXJvZmYiLGlzQmFMc3RyID0gVHJ1ZSkgaWYgY2hhdGxvZ2dlciBlbHNlIF9nZXRUcmFuc1RleHQoImNoYXRsb2dnZXJvbiIsaXNCYUxzdHIgPSBUcnVlKSwKICAgICAgICAgICAgICAgIF9nZXRUcmFuc1RleHQoIkNyZWRpdHNfZm9yX1RoaXMiLGlzQmFMc3RyID0gVHJ1ZSkKICAgICAgICAgICAgICAgIF0KICAgICAgICAKICAgICAgICBpZiBsZW4odHJhblR5cGVzKSA+IDAgOgogICAgICAgICAgICBjaG9pY2VzLmFwcGVuZCgidHJhbnNsYXRvciIpO0Rpc0Nob2ljZXMuYXBwZW5kKF9nZXRUcmFuc1RleHQoIlRyYW5zbGF0b3IiLGlzQmFMc3RyID0gVHJ1ZSkpCiAgICAgICAgCiAgICAgICAgY2hvaWNlcy5hcHBlbmQoInJlc2V0R2FtZVJlY29yZCIpCiAgICAgICAgRGlzQ2hvaWNlcy5hcHBlbmQoX2dldFRyYW5zVGV4dCgiUmVzdGFydF9HYW1lX1JlY29yZCIsaXNCYUxzdHIgPSBUcnVlKSkKICAgICAgICBpZiBzZWxmLl9nZXRDdXN0b21TZXRzKCkuZ2V0KCJFbmFibGVfSG9zdEluZm9fRGVidWciLEZhbHNlKToKICAgICAgICAgICAgY2hvaWNlcy5hcHBlbmQoImhvc3RJbmZvX0RlYnVnIik7RGlzQ2hvaWNlcy5hcHBlbmQoX2dldFRyYW5zVGV4dCgiRGVidWdfZm9yX0hvc3RfSW5mbyIsaXNCYUxzdHIgPSBUcnVlKSkKICAgICAgICAKICAgICAgICBQb3B1cE1lbnVXaW5kb3coCiAgICAgICAgICAgIHBvc2l0aW9uPXNlbGYuX21lbnVfYnV0dG9uLmdldF9zY3JlZW5fc3BhY2VfY2VudGVyKCksCiAgICAgICAgICAgIHNjYWxlPV9nZXRfcG9wdXBfd2luZG93X3NjYWxlKCksCiAgICAgICAgICAgIGNob2ljZXM9Y2hvaWNlcywKICAgICAgICAgICAgY2hvaWNlc19kaXNwbGF5PURpc0Nob2ljZXMsCiAgICAgICAgICAgIGN1cnJlbnRfY2hvaWNlPSJ1bm11dGUiIGlmIGlzX211dGVkIGVsc2UgIm11dGUiLCBkZWxlZ2F0ZT1zZWxmKQogICAgICAgIHNlbGYuX3BvcHVwX3R5cGUgPSAibWVudSIKICAgIGRlZiBfb25fcGFydHlfbWVtYmVyX3ByZXNzKHNlbGYsIGNsaWVudF9pZDogaW50LCBpc19ob3N0OiBib29sLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkZ2V0OiBiYS5XaWRnZXQpIC0+IE5vbmU6CiAgICAgICAgIyBpZiB3ZSJyZSB0aGUgaG9zdCwgcG9wIHVwICJraWNrIiBvcHRpb25zIGZvciBhbGwgbm9uLWhvc3QgbWVtYmVycwogICAgICAgIGlmIF9iYS5nZXRfZm9yZWdyb3VuZF9ob3N0X3Nlc3Npb24oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAga2lja19zdHIgPSBiYS5Mc3RyKHJlc291cmNlPSJraWNrVGV4dCIpCiAgICAgICAgZWxzZTpraWNrX3N0ciA9IGJhLkxzdHIocmVzb3VyY2U9ImtpY2tWb3RlVGV4dCIpCiAgICAgICAgY2hvaWNlcyA9IFsia2ljayIsIkAgdGhpcyBndXkiLCJhZG1pbmtpY2siXQogICAgICAgIAogICAgICAgIGNob2ljZXNfZGlzcGxheSA9IFtraWNrX3N0cixfZ2V0VHJhbnNUZXh0KCJNZW50aW9uX3RoaXNfZ3V5Iixpc0JhTHN0ciA9IFRydWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmEuTHN0cihyZXNvdXJjZSA9ICI/P1Vua25vd24/PyIsZmFsbGJhY2tfdmFsdWUgPSBfZ2V0VHJhbnNUZXh0KCJLaWNrX0lEIiklY2xpZW50X2lkKV0KICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGxlbihzZWxmLl9nZXRDdXN0b21TZXRzKCkuZ2V0KCJwYXJ0eU1lbWJlclByZXNzX0N1c3RvbSIpIGlmIGlzaW5zdGFuY2Uoc2VsZi5fZ2V0Q3VzdG9tU2V0cygpLmdldCgicGFydHlNZW1iZXJQcmVzc19DdXN0b20iKSxkaWN0KSBlbHNlIHt9KSA+IDA6CiAgICAgICAgICAgICAgICBjaG9pY2VzLmFwcGVuZCgiY3VzdG9tQWN0aW9uIik7Y2hvaWNlc19kaXNwbGF5LmFwcGVuZChfZ2V0VHJhbnNUZXh0KCJDdXN0b21fQWN0aW9uIixpc0JhTHN0ciA9IFRydWUpKQogICAgICAgIGV4Y2VwdDpiYS5wcmludF9leGNlcHRpb24oKQogICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgIFBvcHVwTWVudVdpbmRvdyhwb3NpdGlvbj13aWRnZXQuZ2V0X3NjcmVlbl9zcGFjZV9jZW50ZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlPV9nZXRfcG9wdXBfd2luZG93X3NjYWxlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2VzPWNob2ljZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2VzX2Rpc3BsYXk9Y2hvaWNlc19kaXNwbGF5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9jaG9pY2U9IkAgdGhpcyBndXkiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZWdhdGU9c2VsZikKICAgICAgICBzZWxmLl9wb3B1cF9wYXJ0eV9tZW1iZXJfY2xpZW50X2lkID0gY2xpZW50X2lkCiAgICAgICAgc2VsZi5fcG9wdXBfcGFydHlfbWVtYmVyX2lzX2hvc3QgPSBpc19ob3N0CiAgICAgICAgc2VsZi5fcG9wdXBfdHlwZSA9ICJwYXJ0eU1lbWJlclByZXNzIgoKICAgIGRlZiBfc2VuZF9jaGF0X21lc3NhZ2Uoc2VsZikgLT4gTm9uZToKICAgICAgICBzZW5kdGV4dCA9IGJhLnRleHR3aWRnZXQocXVlcnk9c2VsZi5fdGV4dF9maWVsZCkKICAgICAgICBpZiBzZW5kdGV4dD09Ii5pcCI6CiAgICAgICAgICBfYmEuY2hhdG1lc3NhZ2UoIklQICIraXBfYWRkKyIgUE9SVCAiK3N0cihwX3BvcnQpKQogICAgICAgICAgCiAgICAgICAgICBiYS50ZXh0d2lkZ2V0KGVkaXQ9c2VsZi5fdGV4dF9maWVsZCx0ZXh0PSIiKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgZWxpZiBzZW5kdGV4dD09Ii5pbmZvIjoKICAgICAgICAgIGlmIF9iYS5nZXRfY29ubmVjdGlvbl90b19ob3N0X2luZm8oKSA9PSB7fToKICAgICAgICAgICAgc19idWlsZD0wCiAgICAgICAgICBlbHNlOgogICAgICAgICAgICBzX2J1aWxkID0gX2JhLmdldF9jb25uZWN0aW9uX3RvX2hvc3RfaW5mbygpWydidWlsZF9udW1iZXInXQogICAgICAgICAgc192PSIwIgogICAgICAgICAgaWYgc19idWlsZCA8PTE0MzY1OgogICAgICAgICAgICBzX3Y9IiAxLjQuMTQ4IG9yIGJlbG93IgogICAgICAgICAgZWxpZiBzX2J1aWxkIDw9MTQzNzc6CiAgICAgICAgICAgIHNfdj0iMS40LjE0OCA8IHggPCA9IDEuNC4xNTUgIgogICAgICAgICAgZWxpZiBzX2J1aWxkPj0yMDAwMSBhbmQgc19idWlsZCA8IDIwMzA4OgogICAgICAgICAgICBzX3YgPSIxLjUiCiAgICAgICAgICBlbGlmIHNfYnVpbGQgPj0gMjAzMDg6CiAgICAgICAgICAgIHNfdj0iMS42IG9yIGFib3ZlIgogICAgICAgICAgZWxzZToKICAgICAgICAgICAgc192ID0iICIKICAgICAgICAgIF9iYS5jaGF0bWVzc2FnZSgic2NyaXB0IHZlcnNpb24gIitzX3YrIi0gYnVpbGQgIitzdHIoc19idWlsZCkpCiAgICAgICAgICBiYS50ZXh0d2lkZ2V0KGVkaXQ9c2VsZi5fdGV4dF9maWVsZCx0ZXh0PSIiKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgZWxpZiBzZW5kdGV4dD09Ii5waW5nIjoKICAgICAgICAgIFBpbmdUaHJlYWQoaXBfYWRkLCBwX3BvcnQpLnN0YXJ0KCkKICAgICAgICAgIGJhLnRleHR3aWRnZXQoZWRpdD1zZWxmLl90ZXh0X2ZpZWxkLHRleHQ9IiIpCiAgICAgICAgICByZXR1cm4KICAgICAgICBlbGlmIHNlbmR0ZXh0PT0iLnNhdmUiOgogICAgICAgICAgaW5mbyA9IF9iYS5nZXRfY29ubmVjdGlvbl90b19ob3N0X2luZm8oKQogICAgICAgICAgY29uZmlnID0gYmEuYXBwLmNvbmZpZwogICAgICAgICAgaWYgaW5mby5nZXQoJ25hbWUnLCAnJykgIT0gJyc6CiAgICAgICAgICAgIHRpdGxlID0gaW5mb1snbmFtZSddCiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGNvbmZpZy5nZXQoJ1NhdmVkIFNlcnZlcnMnKSwgZGljdCk6CiAgICAgICAgICAgICAgICBjb25maWdbJ1NhdmVkIFNlcnZlcnMnXSA9IHt9CiAgICAgICAgICAgIGNvbmZpZ1snU2F2ZWQgU2VydmVycyddW2Yne2lwX2FkZH1Ae3BfcG9ydH0nXSA9IHsKICAgICAgICAgICAgICAgICdhZGRyJzogaXBfYWRkLAogICAgICAgICAgICAgICAgJ3BvcnQnOiBwX3BvcnQsCiAgICAgICAgICAgICAgICAnbmFtZSc6IHRpdGxlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uZmlnLmNvbW1pdCgpCiAgICAgICAgICAgIGJhLnNjcmVlbm1lc3NhZ2UoIlNlcnZlciBzYXZlZCB0byBtYW51YWwiKQogICAgICAgICAgICBiYS5wbGF5c291bmQoYmEuZ2V0c291bmQoJ2d1bkNvY2tpbmcnKSkKICAgICAgICAgICAgYmEudGV4dHdpZGdldChlZGl0PXNlbGYuX3RleHRfZmllbGQsdGV4dD0iIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgIyBlbGlmIHNlbmR0ZXh0ICE9ICIiOgogICAgICAgICMgICAgIGZvciBpbmRleCBpbiByYW5nZShnZXRhdHRyKHNlbGYsIl9zZW5kX21zZ190aW1lcyIsMSkpOgogICAgICAgIGlmICdcXCcgaW4gc2VuZHRleHQ6CiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xcZCcsICgnXHVlMDQ4JykpCiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xcYycsICgnXHVlMDQzJykpCiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xcaCcsICgnXHVlMDQ5JykpCiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xccycsICgnXHVlMDQ2JykpCiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xcbicsICgnXHVlMDRiJykpCiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xcZicsICgnXHVlMDRmJykpCiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xcZycsICgnXHVlMDI3JykpCiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xcaScsICgnXHVlMDNhJykpCiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xcbScsICgnXHVlMDRkJykpCiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xcdCcsICgnXHVlMDFmJykpCiAgICAgICAgICBzZW5kdGV4dCA9IHNlbmR0ZXh0LnJlcGxhY2UoJ1xcYnMnLCAoJ1x1ZTAxZScpKQogICAgICAgICAgc2VuZHRleHQgPSBzZW5kdGV4dC5yZXBsYWNlKCdcXGonLCAoJ1x1ZTAxMCcpKQogICAgICAgICAgc2VuZHRleHQgPSBzZW5kdGV4dC5yZXBsYWNlKCdcXGUnLCAoJ1x1ZTA0NScpKQogICAgICAgICAgc2VuZHRleHQgPSBzZW5kdGV4dC5yZXBsYWNlKCdcXGwnLCAoJ1x1ZTA0NycpKQogICAgICAgICAgc2VuZHRleHQgPSBzZW5kdGV4dC5yZXBsYWNlKCdcXGEnLCAoJ1x1ZTAyMCcpKQogICAgICAgICAgc2VuZHRleHQgPSBzZW5kdGV4dC5yZXBsYWNlKCdcXGInLCAoJ1x1ZTAwYycpKQogICAgICAgIGlmIHNlbmR0ZXh0PT0iIjoKICAgICAgICAgICAgc2VuZHRleHQ9IiAgICIKICAgICAgICBtc2c9c2VuZHRleHQKICAgICAgICBtc2cxPW1zZy5zcGxpdCgiICIpCiAgICAgICAgbXMyPSIiCiAgICAgICAgaWYobGVuKG1zZzEpPjExKToKICAgICAgICAgICAgaHA9aW50KGxlbihtc2cxKS8yKQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIG0gaW4gcmFuZ2UgKDAsaHApOgogICAgICAgICAgICAgICAgbXMyPW1zMisiICIrbXNnMVttXQogICAgICAgICAgICAKICAgICAgICAgICAgX2JhLmNoYXRtZXNzYWdlKG1zMikKICAgICAgICAgICAgCiAgICAgICAgICAgIG1zMj0iIgogICAgICAgICAgICBmb3IgbSBpbiByYW5nZSAoaHAsbGVuKG1zZzEpKToKICAgICAgICAgICAgICAgIG1zMj1tczIrIiAiK21zZzFbbV0KICAgICAgICAgICAgX2JhLmNoYXRtZXNzYWdlKG1zMikKICAgICAgICBlbHNlOgogICAgICAgICAgICBfYmEuY2hhdG1lc3NhZ2UobXNnKQogICAgICAgIAogICAgICAgIGJhLnRleHR3aWRnZXQoZWRpdD1zZWxmLl90ZXh0X2ZpZWxkLHRleHQ9IiIpCiAgICAgICAgIyBlbHNlOgogICAgICAgICMgICAgIFF1aWNrcmVwbHkgPSBzZWxmLl9nZXRfcXVpY2tfcmVzcG9uZHMoKQogICAgICAgICMgICAgIGlmIGxlbihRdWlja3JlcGx5KSA+IDA6CiAgICAgICAgIyAgICAgICAgIFBvcHVwTWVudVdpbmRvdyhwb3NpdGlvbj1zZWxmLl90ZXh0X2ZpZWxkLmdldF9zY3JlZW5fc3BhY2VfY2VudGVyKCksCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZT1fZ2V0X3BvcHVwX3dpbmRvd19zY2FsZSgpLAogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlcz1RdWlja3JlcGx5LAogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlc19kaXNwbGF5PV9jcmVhdF9Mc3RyX2xpc3QoUXVpY2tyZXBseSksCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2Nob2ljZT1RdWlja3JlcGx5WzBdLAogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZWdhdGU9c2VsZikKICAgICAgICAjICAgICAgICAgc2VsZi5fcG9wdXBfdHlwZSA9ICJRdWlja01lc3NhZ2VTZWxlY3QiCiAgICAgICAgIyAgICAgZWxzZToKICAgICAgICAjICAgICAgICAgX2JhLmNoYXRtZXNzYWdlKHNlbmR0ZXh0KQogICAgICAgICMgICAgICAgICBiYS50ZXh0d2lkZ2V0KGVkaXQ9c2VsZi5fdGV4dF9maWVsZCx0ZXh0PSIiKQogICAgZGVmIF9nZXRfcXVpY2tfcmVzcG9uZHMoc2VsZik6CiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwiX2NhY2hlcyIpIG9yIG5vdCBpc2luc3RhbmNlKHNlbGYuX2NhY2hlcyxkaWN0KTpzZWxmLl9jYWNoZXMgPSB7fQogICAgICAgIHRyeToKICAgICAgICAgICAgZmlsZVBhdGggPSBvcy5wYXRoLmpvaW4oUmVjb3JkRmlsZXNEaXIsIlF1aWNrbWVzc2FnZS50eHQiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoUmVjb3JkRmlsZXNEaXIpIGlzIG5vdCBUcnVlOgogICAgICAgICAgICAgICAgb3MubWFrZWRpcnMoUmVjb3JkRmlsZXNEaXIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2ZpbGUoZmlsZVBhdGgpOgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVQYXRoLCJ3YiIpIGFzIHdyaXRlcjoKICAgICAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGUoKHsiQ2hpbmVzZSI6dSJceGU1XHg4ZVx4ODlceGU1XHhhZVx4YjNceGVmXHhiY1x4OGNceGU4XHhiZlx4OThceGU2XHg5Y1x4ODlceGU4XHhiZlx4OTlceGU3XHhhN1x4OGRceGU5XHhhYVx4OWFceGU2XHg5M1x4OGRceGU0XHhiZFx4OWMhXApceGU0XHhiZFx4YTBceGUyXHg4NFx4YTJceGU4XHg4M1x4YmRceGU1XHg4OFx4YWJceGU2XHg4OVx4OTNceGU5XHg5OFx4OWZceGU1XHg4Zlx4OGJceGU1XHg5MFx4OTdceGVmXHhiY1x4OWZcClx4ZTVceDhmXHhhZlx4ZTRceGJiXHhhNVx4ZTVceDk1XHg4YVx4ZTVceGIxXHg4NVx4ZTdceDg0XHhiNlx4ZThceDgzXHhiZFx4ZThceGJmXHg5OVx4ZTRceGI5XHg4OFx4ZTdceDhlXHhhOVx4ZWZceGJjXHg5ZiJ9LmdldChDdXJyZW50X0xhbmcsIldoYXQgdGhlIGhlbGw/XG5EdWRlIHRoYXQncyBhbWF6aW5nISIpKS5lbmNvZGUoIlVURi04IikpCiAgICAgICAgICAgIGlmIG9zLnBhdGguZ2V0bXRpbWUoZmlsZVBhdGgpICE9IHNlbGYuX2NhY2hlcy5nZXQoIlZlcnRpZnlfUXVpY2tyZXNwb25zZV9UZXh0Iik6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oZmlsZVBhdGgsInJVIiwgZW5jb2RpbmcgPSAiVVRGLTgtc2lnIikgYXMgUmVhZGVyOgogICAgICAgICAgICAgICAgICAgIFRleHQgPSBSZWFkZXIucmVhZCgpCiAgICAgICAgICAgICAgICAgICAgaWYgVGV4dC5zdGFydHN3aXRoKHN0cihjb2RlY3MuQk9NX1VURjgpKToKICAgICAgICAgICAgICAgICAgICAgICAgVGV4dCA9IFRleHRbMzpdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2FjaGVzWyJxdWlja1JlcGx5cyJdID0gKFRleHQpLnNwbGl0KCJcXG4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NhY2hlc1siVmVydGlmeV9RdWlja3Jlc3BvbnNlX1RleHQiXSA9IG9zLnBhdGguZ2V0bXRpbWUoZmlsZVBhdGgpCiAgICAgICAgICAgIHJldHVybihzZWxmLl9jYWNoZXMuZ2V0KCJxdWlja1JlcGx5cyIsW10pKQogICAgICAgIGV4Y2VwdDpiYS5wcmludF9leGNlcHRpb24oKTtiYS5zY3JlZW5tZXNzYWdlKGJhLkxzdHIocmVzb3VyY2U9ImVycm9yVGV4dCIpLCgxLDAsMCkpO2JhLnBsYXlzb3VuZChiYS5nZXRzb3VuZCgiZXJyb3IiKSkKICAgIGRlZiBfd3JpdGVfcXVpY2tfcmVzcG9uZHMoc2VsZixkYXRhKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oUmVjb3JkRmlsZXNEaXIsIlF1aWNrbWVzc2FnZS50eHQiKSwid2IiKSBhcyB3cml0ZXI6CiAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGUoIlxcbiIuam9pbihkYXRhKS5lbmNvZGUoInV0Zi04IikpCiAgICAgICAgZXhjZXB0OmJhLnByaW50X2V4Y2VwdGlvbigpO2JhLnNjcmVlbm1lc3NhZ2UoYmEuTHN0cihyZXNvdXJjZT0iZXJyb3JUZXh0IiksKDEsMCwwKSk7YmEucGxheXNvdW5kKGJhLmdldHNvdW5kKCJlcnJvciIpKQogICAgZGVmIF9nZXRDdXN0b21TZXRzKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwiX2NhY2hlcyIpIG9yIG5vdCBpc2luc3RhbmNlKHNlbGYuX2NhY2hlcyxkaWN0KTpzZWxmLl9jYWNoZXMgPSB7fQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmcm9tIFZpcnR1YWxIb3N0IGltcG9ydCBNYWluU2V0dGluZ3MKICAgICAgICAgICAgICAgIGlmIE1haW5TZXR0aW5ncy5nZXQoIkN1c3RvbV9QYXJ0eVdpbmRvd19TZXRzIix7fSkgIT0gc2VsZi5fY2FjaGVzLmdldCgiUGFydHlXaW5kb3dfU2V0cyIse30pOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NhY2hlc1siUGFydHlXaW5kb3dfU2V0cyJdID0gTWFpblNldHRpbmdzLmdldCgiQ3VzdG9tX1BhcnR5V2luZG93X1NldHMiLHt9KQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZmlsZVBhdGggPSBvcy5wYXRoLmpvaW4oUmVjb3JkRmlsZXNEaXIsIlNldHRpbmdzLmpzb24iKQogICAgICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGZpbGVQYXRoKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgb3MucGF0aC5nZXRtdGltZShmaWxlUGF0aCkgIT0gc2VsZi5fY2FjaGVzLmdldCgiVmVydGlmeV9NYWluU2V0dGluZ3MuanNvbl9UZXh0Iik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4oZmlsZVBhdGgsInJVIiwgZW5jb2RpbmcgPSAiVVRGLTgtc2lnIikgYXMgUmVhZGVyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRleHQgPSBSZWFkZXIucmVhZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgVGV4dC5zdGFydHN3aXRoKHN0cihjb2RlY3MuQk9NX1VURjgpKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGV4dCA9IFRleHRbMzpdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2FjaGVzWyJQYXJ0eVdpbmRvd19TZXRzIl0gPSBqc29uLmxvYWRzKFRleHQuZGVjb2RlKCJ1dGYtOCIpKS5nZXQoIkN1c3RvbV9QYXJ0eVdpbmRvd19TZXRzIix7fSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2NhY2hlc1siVmVydGlmeV9NYWluU2V0dGluZ3MuanNvbl9UZXh0Il0gPSBvcy5wYXRoLmdldG10aW1lKGZpbGVQYXRoKQogICAgICAgICAgICAgICAgZXhjZXB0OmJhLnByaW50X2V4Y2VwdGlvbigpCiAgICAgICAgICAgIHJldHVybihzZWxmLl9jYWNoZXMuZ2V0KCJQYXJ0eVdpbmRvd19TZXRzIikgaWYgaXNpbnN0YW5jZShzZWxmLl9jYWNoZXMuZ2V0KCJQYXJ0eVdpbmRvd19TZXRzIiksZGljdCkgZWxzZSB7fSkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0OmJhLnByaW50X2V4Y2VwdGlvbigpCiAgICBkZWYgX2dldE9iamVjdEJ5SUQoc2VsZix0eXBlID0gInBsYXllck5hbWUiLElEID0gTm9uZSk6CiAgICAgICAgaWYgSUQgaXMgTm9uZTpJRCA9IHNlbGYuX3BvcHVwX3BhcnR5X21lbWJlcl9jbGllbnRfaWQKICAgICAgICB0eXBlID0gdHlwZS5sb3dlcigpO291dHB1dCA9IFtdCiAgICAgICAgZm9yIHJvc3RlciBpbiBzZWxmLl9yb3N0ZXI6CiAgICAgICAgICAgIGlmIHR5cGUuc3RhcnRzd2l0aCgiYWxsIik6CiAgICAgICAgICAgICAgICBpZiB0eXBlIGluICgicm9zdGVyIiwiZnVsbHJlY29yZCIpOm91dHB1dCArPSBbcm9zdGVyXQogICAgICAgICAgICAgICAgZWxpZiB0eXBlLmZpbmQoInBsYXllciIpICE9IC0xIGFuZCByb3N0ZXJbInBsYXllcnMiXSAhPSBbXToKICAgICAgICAgICAgICAgICAgICBpZiB0eXBlLmZpbmQoIm5hbWVmdWxsIikgIT0gLTE6b3V0cHV0ICs9IFsoaVsibmFtZV9mdWxsIl0pIGZvciBpIGluIHJvc3RlclsicGxheWVycyJdXQogICAgICAgICAgICAgICAgICAgIGVsaWYgdHlwZS5maW5kKCJuYW1lIikgIT0gLTE6b3V0cHV0ICs9IFsoaVsibmFtZSJdKSBmb3IgaSBpbiByb3N0ZXJbInBsYXllcnMiXV0KICAgICAgICAgICAgICAgICAgICBlbGlmIHR5cGUuZmluZCgicGxheWVyaWQiKSAhPSAtMTpvdXRwdXQgKz0gW2lbImlkIl0gZm9yIGkgaW4gcm9zdGVyWyJwbGF5ZXJzIl1dCiAgICAgICAgICAgICAgICBlbGlmIHR5cGUubG93ZXIoKSBpbiAoImFjY291bnQiLCJkaXNwbGF5c3RyaW5nIik6b3V0cHV0ICs9IFsocm9zdGVyWyJkaXNwbGF5X3N0cmluZyJdKV0KICAgICAgICAgICAgZWxpZiByb3N0ZXJbImNsaWVudF9pZCJdID09IElEIGFuZCBub3QgdHlwZS5zdGFydHN3aXRoKCJhbGwiKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiB0eXBlIGluICgicm9zdGVyIiwiZnVsbHJlY29yZCIpOnJldHVybihyb3N0ZXIpCiAgICAgICAgICAgICAgICAgICAgZWxpZiB0eXBlLmZpbmQoInBsYXllciIpICE9IC0xIGFuZCByb3N0ZXJbInBsYXllcnMiXSAhPSBbXToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHJvc3RlclsicGxheWVycyJdKSA9PSAxIG9yIHR5cGUuZmluZCgic2luZ2xlcGxheWVyIikgIT0gLTE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0eXBlLmZpbmQoIm5hbWVmdWxsIikgIT0gLTE6cmV0dXJuKChyb3N0ZXJbInBsYXllcnMiXVswXVsibmFtZV9mdWxsIl0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiB0eXBlLmZpbmQoIm5hbWUiKSAhPSAtMTpyZXR1cm4oKHJvc3RlclsicGxheWVycyJdWzBdWyJuYW1lIl0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiB0eXBlLmZpbmQoInBsYXllcmlkIikgIT0gLTE6cmV0dXJuKHJvc3RlclsicGxheWVycyJdWzBdWyJpZCJdKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdHlwZS5maW5kKCJuYW1lZnVsbCIpICE9IC0xOnJldHVybihbKGlbIm5hbWVfZnVsbCJdKSBmb3IgaSBpbiByb3N0ZXJbInBsYXllcnMiXV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGlmIHR5cGUuZmluZCgibmFtZSIpICE9IC0xOnJldHVybihbKGlbIm5hbWUiXSkgZm9yIGkgaW4gcm9zdGVyWyJwbGF5ZXJzIl1dKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiB0eXBlLmZpbmQoInBsYXllcmlkIikgIT0gLTE6cmV0dXJuKFtpWyJpZCJdIGZvciBpIGluIHJvc3RlclsicGxheWVycyJdXSkKICAgICAgICAgICAgICAgICAgICBlbGlmIHR5cGUubG93ZXIoKSBpbiAoImFjY291bnQiLCJkaXNwbGF5c3RyaW5nIik6cmV0dXJuKChyb3N0ZXJbImRpc3BsYXlfc3RyaW5nIl0pKQogICAgICAgICAgICAgICAgZXhjZXB0OmJhLnByaW50X2V4Y2VwdGlvbigpCgogICAgICAgIHJldHVybihOb25lIGlmIGxlbihvdXRwdXQpID09IDAgZWxzZSBvdXRwdXQpCiAgICBkZWYgX2VkaXRfdGV4dF9tc2dfYm94KHNlbGYsdGV4dCx0eXBlID0gInJld3JpdGUiKToKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZSh0eXBlLHN0cikgb3Igbm90IGlzaW5zdGFuY2UodGV4dCxzdHIpOnJldHVybgogICAgICAgIHR5cGUgPSB0eXBlLmxvd2VyKCk7dGV4dCA9ICh0ZXh0KQogICAgICAgIGlmIHR5cGUuZmluZCgiYWRkIikgIT0gLTE6YmEudGV4dHdpZGdldChlZGl0PXNlbGYuX3RleHRfZmllbGQsdGV4dD1iYS50ZXh0d2lkZ2V0KHF1ZXJ5PXNlbGYuX3RleHRfZmllbGQpK3RleHQpCiAgICAgICAgZWxzZTpiYS50ZXh0d2lkZ2V0KGVkaXQ9c2VsZi5fdGV4dF9maWVsZCx0ZXh0PXRleHQpCiAgICBkZWYgX3NlbmRfYWRtaW5fa2lja19jb21tYW5kKHNlbGYpOl9iYS5jaGF0bWVzc2FnZSgiL2tpY2sgIiArIHN0cihzZWxmLl9wb3B1cF9wYXJ0eV9tZW1iZXJfY2xpZW50X2lkKSkKICAgIGRlZiBuZXdfaW5wdXRfd2luZG93X2NhbGxiYWNrKHNlbGYsZ290X3RleHQsIGZsYWcsIGNvZGUpOgogICAgICAgIGlmIGdvdF90ZXh0OgogICAgICAgICAgICBpZiBmbGFnLnN0YXJ0c3dpdGgoIkhvc3RfS2lja19QbGF5ZXI6Iik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gX2JhLmRpc2Nvbm5lY3RfY2xpZW50KHNlbGYuX3BvcHVwX3BhcnR5X21lbWJlcl9jbGllbnRfaWQsIGJhbl90aW1lPWludChjb2RlKSkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgcmVzdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBiYS5wbGF5c291bmQoYmEuZ2V0c291bmQoJ2Vycm9yJykpCiAgICAgICAgICAgICAgICAgICAgICAgIGJhLnNjcmVlbm1lc3NhZ2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYS5Mc3RyKHJlc291cmNlPSdnZXRUaWNrZXRzV2luZG93LnVuYXZhaWxhYmxlVGV4dCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I9KDEsIDAsIDApKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIGJhLnBsYXlzb3VuZChiYS5nZXRzb3VuZCgnZXJyb3InKSkKICAgICAgICAgICAgICAgICAgICBwcmludCh0cmFjZWJhY2suZm9ybWF0X2V4YygpKQogICAgICAgICAgICAgICAgCiAgICAgICAgCiAgICBkZWYgX2tpY2tfc2VsZWN0ZWRfcGxheWVyKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIHJlc3VsdCA9IF9iYS5fZGlzY29ubmVjdENsaWVudChzZWxmLl9wb3B1cF9wYXJ0eV9tZW1iZXJfY2xpZW50X2lkLGJhblRpbWUpCiAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgYmEucGxheXNvdW5kKGJhLmdldHNvdW5kKCJlcnJvciIpKQogICAgICAgICAgICBiYS5zY3JlZW5tZXNzYWdlKGJhLkxzdHIocmVzb3VyY2U9ImdldFRpY2tldHNXaW5kb3cudW5hdmFpbGFibGVUZXh0IiksY29sb3I9KDEsMCwwKSkKICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLl9wb3B1cF9wYXJ0eV9tZW1iZXJfY2xpZW50X2lkICE9IC0xOgogICAgICAgICAgICBpZiBfYmEuZ2V0X2ZvcmVncm91bmRfaG9zdF9zZXNzaW9uKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLl9wb3B1cF90eXBlID0gImJhblRpbWVQcmVzcyIKICAgICAgICAgICAgICAgIGNob2ljZXMgPSBbMCwzMCw2MCwxMjAsMzAwLDYwMCw5MDAsMTgwMCwzNjAwLDcyMDAsOTk5OTk5OTldIGlmIG5vdCAoaXNpbnN0YW5jZShzZWxmLl9nZXRDdXN0b21TZXRzKCkuZ2V0KCJCYW5fVGltZV9MaXN0IiksbGlzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBhbGwoW2lzaW5zdGFuY2UoaXRlbSxpbnQpIGZvciBpdGVtIGluIHNlbGYuX2dldEN1c3RvbVNldHMoKS5nZXQoIkJhbl9UaW1lX0xpc3QiKV0pKSBlbHNlIHNlbGYuX2dldEN1c3RvbVNldHMoKS5nZXQoIkJhbl9UaW1lX0xpc3QiKQogICAgICAgICAgICAgICAgUG9wdXBNZW51V2luZG93KHBvc2l0aW9uPXNlbGYuZ2V0X3Jvb3Rfd2lkZ2V0KCkuZ2V0X3NjcmVlbl9zcGFjZV9jZW50ZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZT1fZ2V0X3BvcHVwX3dpbmRvd19zY2FsZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXM9W3N0cihpdGVtKSBmb3IgaXRlbSBpbiBjaG9pY2VzXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2VzX2Rpc3BsYXk9X2NyZWF0X0xzdHJfbGlzdChbX2dldFRyYW5zVGV4dCgiQmFuX0Zvcl8lZF9TZWNvbmRzIiklaXRlbSBmb3IgaXRlbSBpbiBjaG9pY2VzXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9jaG9pY2U9IlNoYXJlX1NlcnZlcl9JbmZvIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxlZ2F0ZT1zZWxmKQogICAgICAgICAgICAgICAgIiIiCiAgICAgICAgICAgICAgICBOZXdJbnB1dFdpbmRvdyhvcmlnaW5fd2lkZ2V0ID0gc2VsZi5nZXRfcm9vdF93aWRnZXQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGVnYXRlID0gc2VsZixwb3N0X3RleHQgPSBfZ2V0VHJhbnNUZXh0KCJCYW5fVGltZV9Qb3N0IiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0X2NvZGUgPSAiMzAwIixmbGFnID0gIkhvc3RfS2lja19QbGF5ZXI6IitzdHIoc2VsZi5fcG9wdXBfcGFydHlfbWVtYmVyX2NsaWVudF9pZCkpCiAgICAgICAgICAgICAgICAiIiIKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMga2ljay12b3RlcyBhcHBlYXJlZCBpbiBidWlsZCAxNDI0OAogICAgICAgICAgICAgICAgaWYgKF9iYS5nZXRfY29ubmVjdGlvbl90b19ob3N0X2luZm8oKS5nZXQoJ2J1aWxkX251bWJlcicsIDApIDwKICAgICAgICAgICAgICAgICAgICAgICAgMTQyNDgpOgogICAgICAgICAgICAgICAgICAgIGJhLnBsYXlzb3VuZChiYS5nZXRzb3VuZCgnZXJyb3InKSkKICAgICAgICAgICAgICAgICAgICBiYS5zY3JlZW5tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICAgICBiYS5Mc3RyKHJlc291cmNlPSdnZXRUaWNrZXRzV2luZG93LnVuYXZhaWxhYmxlVGV4dCcpLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcj0oMSwgMCwgMCkpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgQmFuIGZvciA1IG1pbnV0ZXMuCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gX2JhLmRpc2Nvbm5lY3RfY2xpZW50KHNlbGYuX3BvcHVwX3BhcnR5X21lbWJlcl9jbGllbnRfaWQsIGJhbl90aW1lPTUgKiA2MCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgcmVzdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBiYS5wbGF5c291bmQoYmEuZ2V0c291bmQoJ2Vycm9yJykpCiAgICAgICAgICAgICAgICAgICAgICAgIGJhLnNjcmVlbm1lc3NhZ2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYS5Mc3RyKHJlc291cmNlPSdnZXRUaWNrZXRzV2luZG93LnVuYXZhaWxhYmxlVGV4dCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I9KDEsIDAsIDApKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGJhLnBsYXlzb3VuZChiYS5nZXRzb3VuZCgnZXJyb3InKSkKICAgICAgICAgICAgYmEuc2NyZWVubWVzc2FnZSgKICAgICAgICAgICAgICAgIGJhLkxzdHIocmVzb3VyY2U9J2ludGVybmFsLmNhbnRLaWNrSG9zdEVycm9yJyksCiAgICAgICAgICAgICAgICBjb2xvcj0oMSwgMCwgMCkpCiAgICAgICAgICAgIAogICAgICAgICNOZXdTaGFyZUNvZGVXaW5kb3cob3JpZ2luX3dpZGdldD1zZWxmLmdldF9yb290X3dpZGdldCgpLCBkZWxlZ2F0ZT1Ob25lLGNvZGUgPSAiMzAwIixleGVjVGV4dCA9IHUiX2JhLl9kaXNjb25uZWN0Q2xpZW50KCVkLHtWYWx1ZX0pIiVzZWxmLl9wb3B1cF9wYXJ0eV9tZW1iZXJfY2xpZW50X2lkKQogICAgZGVmIGpvaW5ib21ic3BvdChzZWxmKToKICAgICAgICBpbXBvcnQgcmFuZG9tCiAgICAgICAgdXJsPVsnaHR0cHM6Ly9kaXNjb3JkLmdnL0NieGhKVHJSdGEnLCdodHRwczovL2Rpc2NvcmQuZ2cvdWN5YWVzaCddCiAgICAgICAgYmEub3Blbl91cmwodXJsW3JhbmRvbS5yYW5kaW50KDAsMSldKQogICAgZGVmIF91cGRhdGUoc2VsZikgLT4gTm9uZToKICAgICAgICAjIHB5bGludDogZGlzYWJsZT10b28tbWFueS1sb2NhbHMKICAgICAgICAjIHB5bGludDogZGlzYWJsZT10b28tbWFueS1icmFuY2hlcwogICAgICAgICMgcHlsaW50OiBkaXNhYmxlPXRvby1tYW55LXN0YXRlbWVudHMKICAgICAgICAjIHB5bGludDogZGlzYWJsZT10b28tbWFueS1uZXN0ZWQtYmxvY2tzCgogICAgICAgICMgIyB1cGRhdGUgbXV0ZWQgc3RhdGUKICAgICAgICAjIGlmIGJhLmFwcC5jb25maWcucmVzb2x2ZSgnQ2hhdCBNdXRlZCcpOgogICAgICAgICMgICAgIGJhLnRleHR3aWRnZXQoZWRpdD1zZWxmLl9tdXRlZF90ZXh0LCBjb2xvcj0oMSwgMSwgMSwgMC4zKSkKICAgICAgICAjICAgICAjIGNsZWFyIGFueSBjaGF0IHRleHRzIHdlJ3JlIHNob3dpbmcKICAgICAgICAjICAgICBpZiBzZWxmLl9jaGF0X3RleHRzOgogICAgICAgICMgICAgICAgICB3aGlsZSBzZWxmLl9jaGF0X3RleHRzOgogICAgICAgICMgICAgICAgICAgICAgZmlyc3QgPSBzZWxmLl9jaGF0X3RleHRzLnBvcCgpCiAgICAgICAgIyAgICAgICAgICAgICBmaXJzdC5kZWxldGUoKQogICAgICAgICMgZWxzZToKICAgICAgICAjICAgICBiYS50ZXh0d2lkZ2V0KGVkaXQ9c2VsZi5fbXV0ZWRfdGV4dCwgY29sb3I9KDEsIDEsIDEsIDAuMCkpCgogICAgICAgICMgdXBkYXRlIHJvc3RlciBzZWN0aW9uCiAgICAgICAgCiAgICAgICAgcm9zdGVyID0gX2JhLmdldF9nYW1lX3Jvc3RlcigpCiAgICAgICAgZ2xvYmFsIGZfY2hhdAogICAgICAgIGdsb2JhbCBzbW9fbW9kZQogICAgICAgIGlmIHJvc3RlciAhPSBzZWxmLl9yb3N0ZXIgb3Igc21vX21vZGUhPXNlbGYuc21vb3RoeV9tb2RlIG9yIGZfY2hhdCE9c2VsZi5mdWxsX2NoYXRfbW9kZToKICAgICAgICAgICAgc2VsZi5fcm9zdGVyID0gcm9zdGVyCiAgICAgICAgICAgIHNtb19tb2RlPXNlbGYuc21vb3RoeV9tb2RlCiAgICAgICAgICAgIGZfY2hhdD1zZWxmLmZ1bGxfY2hhdF9tb2RlCiAgICAgICAgICAgICMgY2xlYXIgb3V0IG9sZAogICAgICAgICAgICBmb3Igd2lkZ2V0IGluIHNlbGYuX25hbWVfd2lkZ2V0czoKICAgICAgICAgICAgICAgIHdpZGdldC5kZWxldGUoKQogICAgICAgICAgICBzZWxmLl9uYW1lX3dpZGdldHMgPSBbXQoKICAgICAgICAgICAgaWYgbm90IHNlbGYuX3Jvc3RlciA6CiAgICAgICAgICAgICAgICB0b3Bfc2VjdGlvbl9oZWlnaHQgPSA2MAogICAgICAgICAgICAgICAgYmEudGV4dHdpZGdldChlZGl0PXNlbGYuX2VtcHR5X3N0ciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dD1iYS5Mc3RyKHJlc291cmNlPXNlbGYuX3IgKyAnLmVtcHR5VGV4dCcpKQogICAgICAgICAgICAgICAgYmEuc2Nyb2xsd2lkZ2V0KGVkaXQ9c2VsZi5fc2Nyb2xsd2lkZ2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU9KHNlbGYuX3dpZHRoIC0gNTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5faGVpZ2h0IC0gdG9wX3NlY3Rpb25faGVpZ2h0IC0gMTEwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbj0oMzAsIDgwKSkKICAgICAgICAgICAgZWxpZiBzZWxmLmZ1bGxfY2hhdF9tb2RlOgogICAgICAgICAgICAgICAgdG9wX3NlY3Rpb25faGVpZ2h0ID0gNjAKICAgICAgICAgICAgICAgIGJhLnNjcm9sbHdpZGdldChlZGl0PXNlbGYuX3Njcm9sbHdpZGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPShzZWxmLl93aWR0aCAtIDUwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2hlaWdodCAtIHRvcF9zZWN0aW9uX2hlaWdodCAtIDc1KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbj0oMzAsIDgwKSkKCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjb2x1bW5zID0gMSBpZiBsZW4oCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcm9zdGVyKSA9PSAxIGVsc2UgMiBpZiBsZW4oc2VsZi5fcm9zdGVyKSA9PSAyIGVsc2UgMwogICAgICAgICAgICAgICAgcm93cyA9IGludChtYXRoLmNlaWwoZmxvYXQobGVuKHNlbGYuX3Jvc3RlcikpIC8gY29sdW1ucykpCiAgICAgICAgICAgICAgICBjX3dpZHRoID0gKHNlbGYuX3dpZHRoICogMC45KSAvIG1heCgzLCBjb2x1bW5zKQogICAgICAgICAgICAgICAgY193aWR0aF90b3RhbCA9IGNfd2lkdGggKiBjb2x1bW5zCiAgICAgICAgICAgICAgICBjX2hlaWdodCA9IDI0CiAgICAgICAgICAgICAgICBjX2hlaWdodF90b3RhbCA9IGNfaGVpZ2h0ICogcm93cwogICAgICAgICAgICAgICAgZm9yIHkgaW4gcmFuZ2Uocm93cyk6CiAgICAgICAgICAgICAgICAgICAgZm9yIHggaW4gcmFuZ2UoY29sdW1ucyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0geSAqIGNvbHVtbnMgKyB4CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGluZGV4IDwgbGVuKHNlbGYuX3Jvc3Rlcik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0X3NjYWxlID0gMC42NQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gKHNlbGYuX3dpZHRoICogMC41MyAtIGNfd2lkdGhfdG90YWwgKiAwLjUgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNfd2lkdGggKiB4IC0gMjMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5faGVpZ2h0IC0gNjUgLSBjX2hlaWdodCAqIHkgLSAxNSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGlmIHRoZXJlIGFyZSBwbGF5ZXJzIHByZXNlbnQgZm9yIHRoaXMgY2xpZW50LCB1c2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgdGhlaXIgbmFtZXMgYXMgYSBkaXNwbGF5IHN0cmluZyBpbnN0ZWFkIG9mIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBjbGllbnQgc3BlYy1zdHJpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnNtb290aHlfbW9kZSA9PTEgYW5kIHNlbGYuX3Jvc3RlcltpbmRleF1bJ3BsYXllcnMnXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBpZiB0aGVyZSdzIGp1c3Qgb25lLCB1c2UgdGhlIGZ1bGwgbmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBvdGhlcndpc2UgY29tYmluZSBzaG9ydCBuYW1lcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4oc2VsZi5fcm9zdGVyW2luZGV4XQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWydwbGF5ZXJzJ10pID09IDE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwX3N0ciA9IHNlbGYuX3Jvc3RlcltpbmRleF1bJ3BsYXllcnMnXVsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwXVsnbmFtZV9mdWxsJ10KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBfc3RyID0gKCcvJy5qb2luKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeVsnbmFtZSddIGZvciBlbnRyeSBpbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Jvc3RlcltpbmRleF1bJ3BsYXllcnMnXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocF9zdHIpID4gMjU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcF9zdHIgPSBwX3N0cls6MjVdICsgJy4uLicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGlmIHNlbGYuc21vb3RoeV9tb2RlPT0wIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcF9zdHIgPSBzZWxmLl9yb3N0ZXJbaW5kZXhdWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Rpc3BsYXlfc3RyaW5nJ10KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcF9zdHI9IHNlbGYuX2dldF9uaWNrKHBfc3RyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcF9zdHIgPSBzZWxmLl9yb3N0ZXJbaW5kZXhdWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Rpc3BsYXlfc3RyaW5nJ10KCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYS5wcmludF9leGNlcHRpb24oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdFcnJvciBjYWxjaW5nIGNsaWVudCBuYW1lIHN0ci4nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBfc3RyID0gJz8/PycKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkZ2V0ID0gYmEudGV4dHdpZGdldChwYXJlbnQ9c2VsZi5fcm9vdF93aWRnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb249KHBvc1swXSwgcG9zWzFdKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZT10X3NjYWxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU9KGNfd2lkdGggKiAwLjg1LCAzMCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4d2lkdGg9Y193aWR0aCAqIDAuODUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I9KDEsIDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEpIGlmIGluZGV4ID09IDAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgxLCAxLCAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RhYmxlPVRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXV0b3NlbGVjdD1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrX2FjdGl2YXRlPVRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dD1iYS5Mc3RyKHZhbHVlPXBfc3RyKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoX2FsaWduPSdsZWZ0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2X2FsaWduPSdjZW50ZXInKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9uYW1lX3dpZGdldHMuYXBwZW5kKHdpZGdldCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgaW4gbmV3ZXIgdmVyc2lvbnMgY2xpZW50X2lkIHdpbGwgYmUgcHJlc2VudCBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgd2UgY2FuIHVzZSB0aGF0IHRvIGRldGVybWluZSB3aG8gdGhlIGhvc3QgaXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGluIG9sZGVyIHZlcnNpb25zIHdlIGFzc3VtZSB0aGUgZmlyc3QgY2xpZW50IGlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGhvc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3Jvc3RlcltpbmRleF1bJ2NsaWVudF9pZCddIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX2hvc3QgPSBzZWxmLl9yb3N0ZXJbaW5kZXhdWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2xpZW50X2lkJ10gPT0gLTEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfaG9zdCA9IChpbmRleCA9PSAwKQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgRklYTUU6IFNob3VsZCBwYXNzIGNsaWVudF9pZCB0byB0aGVzZSBzb3J0IG9mCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjICBjYWxsczsgbm90IHNwZWMtc3RyaW5nIChwZXJoYXBzIHNob3VsZCB3YWl0IHRpbGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgIGNsaWVudF9pZCBpcyBtb3JlIHJlYWRpbHkgYXZhaWxhYmxlIHRob3VnaCkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhLnRleHR3aWRnZXQoZWRpdD13aWRnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25fYWN0aXZhdGVfY2FsbD1iYS5DYWxsKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9vbl9wYXJ0eV9tZW1iZXJfcHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Jvc3RlcltpbmRleF1bJ2NsaWVudF9pZCddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc19ob3N0LCB3aWRnZXQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gKHNlbGYuX3dpZHRoICogMC41MyAtIGNfd2lkdGhfdG90YWwgKiAwLjUgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNfd2lkdGggKiB4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2hlaWdodCAtIDY1IC0gY19oZWlnaHQgKiB5KQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTWFrZSB0aGUgYXNzdW1wdGlvbiB0aGF0IHRoZSBmaXJzdCByb3N0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgZW50cnkgaXMgdGhlIHNlcnZlci4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgRklYTUU6IFNob3VsZG4ndCBkbyB0aGlzLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNfaG9zdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0d2QgPSBtaW4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNfd2lkdGggKiAwLjg1LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYmEuZ2V0X3N0cmluZ193aWR0aCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBfc3RyLCBzdXBwcmVzc193YXJuaW5nPVRydWUpICoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdF9zY2FsZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9uYW1lX3dpZGdldHMuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhLnRleHR3aWRnZXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudD1zZWxmLl9yb290X3dpZGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb249KHBvc1swXSArIHR3ZCArIDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NbMV0gLSAwLjUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPSgwLCAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaF9hbGlnbj0nbGVmdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZfYWxpZ249J2NlbnRlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heHdpZHRoPWNfd2lkdGggKiAwLjk2IC0gdHdkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcj0oMC4xLCAxLCAwLjEsIDAuNSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ9YmEuTHN0cihyZXNvdXJjZT1zZWxmLl9yICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcuaG9zdFRleHQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU9MC40LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFkb3c9MC4xLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGF0bmVzcz0xLjApKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgIGJhLnRleHR3aWRnZXQoZWRpdD1zZWxmLl9lbXB0eV9zdHIsIHRleHQ9JycpCiAgICAgICAgICAgICAgICAgIGJhLnNjcm9sbHdpZGdldChlZGl0PXNlbGYuX3Njcm9sbHdpZGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplPShzZWxmLl93aWR0aCAtIDUwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heCgxMDAsIHNlbGYuX2hlaWdodCAtIDEzOSAtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNfaGVpZ2h0X3RvdGFsKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb249KDMwLCA4MCkpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICBwYXNzCiAgICBkZWYgaGlkZV9zY3JlZW5fbXNnKHNlbGYpOgogICAgICAgIGZpbGU9b3BlbignYmFfZGF0YS9kYXRhL2xhbmd1YWdlcy9lbmdsaXNoLmpzb24nKQogICAgICAgIGVuZz1qc29uLmxvYWRzKGZpbGUucmVhZCgpKQogICAgICAgIGZpbGUuY2xvc2UoKQogICAgICAgIGVuZ1snaW50ZXJuYWwnXVsncGxheWVySm9pbmVkUGFydHlUZXh0J109JycKICAgICAgICBlbmdbJ2ludGVybmFsJ11bJ3BsYXllckxlZnRQYXJ0eVRleHQnXT0nJwogICAgICAgIGVuZ1snaW50ZXJuYWwnXVsnY2hhdEJsb2NrZWRUZXh0J109JycKICAgICAgICBlbmdbJ2tpY2tWb3RlU3RhcnRlZFRleHQnXT0nJwogICAgICAgICMgZW5nWydraWNrVm90ZVRleHQnXT0nJwogICAgICAgIGVuZ1sna2lja1dpdGhDaGF0VGV4dCddPScnCiAgICAgICAgZW5nWydraWNrT2NjdXJyZWRUZXh0J109JycKICAgICAgICBlbmdbJ2tpY2tWb3RlRmFpbGVkVGV4dCddPScnCiAgICAgICAgZW5nWyd2b3Rlc05lZWRlZFRleHQnXT0nJwogICAgICAgIGVuZ1sncGxheWVyRGVsYXllZEpvaW5UZXh0J109JycKICAgICAgICBlbmdbJ3BsYXllckxlZnRUZXh0J109JycKICAgICAgICBlbmdbJ2tpY2tRdWVzdGlvblRleHQnXT0nJwogICAgICAgIGZpbGU9b3BlbignYmFfZGF0YS9kYXRhL2xhbmd1YWdlcy9lbmdsaXNoLmpzb24nLCJ3IikKICAgICAgICBqc29uLmR1bXAoZW5nLGZpbGUpCiAgICAgICAgZmlsZS5jbG9zZSgpCiAgICAgICAgYmEuYXBwLmxhbmcuc2V0bGFuZ3VhZ2UoTm9uZSkKCiAgICBkZWYgcmVzdG9yZV9zY3JlZW5fbXNnKHNlbGYpOgogICAgICAgIGZpbGU9b3BlbignYmFfZGF0YS9kYXRhL2xhbmd1YWdlcy9lbmdsaXNoLmpzb24nKQogICAgICAgIGVuZz1qc29uLmxvYWRzKGZpbGUucmVhZCgpKQogICAgICAgIGZpbGUuY2xvc2UoKQogICAgICAgIGVuZ1snaW50ZXJuYWwnXVsncGxheWVySm9pbmVkUGFydHlUZXh0J109IiR7TkFNRX0gam9pbmVkIHRoZSBwYXdyaSEiCiAgICAgICAgZW5nWydpbnRlcm5hbCddWydwbGF5ZXJMZWZ0UGFydHlUZXh0J109IiR7TkFNRX0gbGVmdCB0aGUgcGF3cmkuIgogICAgICAgIGVuZ1snaW50ZXJuYWwnXVsnY2hhdEJsb2NrZWRUZXh0J109IiR7TkFNRX0gaXMgY2hhdC1ibG9ja2VkIGZvciAke1RJTUV9IHNlY29uZHMuIgogICAgICAgIGVuZ1sna2lja1ZvdGVTdGFydGVkVGV4dCddPSJBIGtpY2sgdm90ZSBoYXMgYmVlbiBzdGFydGVkIGZvciAke05BTUV9LiIKICAgICAgICAjIGVuZ1sna2lja1ZvdGVUZXh0J109JycKICAgICAgICBlbmdbJ2tpY2tXaXRoQ2hhdFRleHQnXT0iVHlwZSAke1lFU30gaW4gY2hhdCBmb3IgeWVzIGFuZCAke05PfSBmb3Igbm8uIgogICAgICAgIGVuZ1sna2lja09jY3VycmVkVGV4dCddPSIke05BTUV9IHdhcyBraWNrZWQuIgogICAgICAgIGVuZ1sna2lja1ZvdGVGYWlsZWRUZXh0J109IktpY2stdm90ZSBmYWlsZWQuIgogICAgICAgIGVuZ1sndm90ZXNOZWVkZWRUZXh0J109IiR7TlVNQkVSfSB2b3RlcyBuZWVkZWQiCiAgICAgICAgZW5nWydwbGF5ZXJEZWxheWVkSm9pblRleHQnXT0iJHtQTEFZRVJ9IHdpbGwgZW50ZXIgYXQgdGhlIHN0YXJ0IG9mIHRoZSBuZXh0IHJvdW5kLiIKICAgICAgICBlbmdbJ3BsYXllckxlZnRUZXh0J109IiR7UExBWUVSfSBsZWZ0IHRoZSBnYW1lLiIKICAgICAgICBlbmdbJ2tpY2tRdWVzdGlvblRleHQnXT0iS2ljayAke05BTUV9PyIKICAgICAgICBmaWxlPW9wZW4oJ2JhX2RhdGEvZGF0YS9sYW5ndWFnZXMvZW5nbGlzaC5qc29uJywidyIpCiAgICAgICAganNvbi5kdW1wKGVuZyxmaWxlKQogICAgICAgIGZpbGUuY2xvc2UoKQogICAgICAgIGJhLmFwcC5sYW5nLnNldGxhbmd1YWdlKE5vbmUpCiAgICBkZWYgcG9wdXBfbWVudV9zZWxlY3RlZF9jaG9pY2Uoc2VsZiwgcG9wdXBfd2luZG93OiBQb3B1cE1lbnVXaW5kb3csCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlOiBzdHIpIC0+IE5vbmU6CiAgICAgICAgIiIiQ2FsbGVkIHdoZW4gYSBjaG9pY2UgaXMgc2VsZWN0ZWQgaW4gdGhlIHBvcHVwLiIiIgogICAgICAgIGdsb2JhbCB1bm11dGVkX25hbWVzCiAgICAgICAgaWYgc2VsZi5fcG9wdXBfdHlwZSA9PSAiYmFuVGltZVByZXNzIjoKICAgICAgICAgICAgcmVzdWx0ID0gX2JhLmRpc2Nvbm5lY3RfY2xpZW50KHNlbGYuX3BvcHVwX3BhcnR5X21lbWJlcl9jbGllbnRfaWQsIGJhbl90aW1lPWludChjaG9pY2UpKQogICAgICAgICAgICBpZiBub3QgcmVzdWx0OgogICAgICAgICAgICAgICAgYmEucGxheXNvdW5kKGJhLmdldHNvdW5kKCdlcnJvcicpKQogICAgICAgICAgICAgICAgYmEuc2NyZWVubWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICBiYS5Mc3RyKHJlc291cmNlPSdnZXRUaWNrZXRzV2luZG93LnVuYXZhaWxhYmxlVGV4dCcpLAogICAgICAgICAgICAgICAgICAgIGNvbG9yPSgxLCAwLCAwKSkKICAgICAgICBlbGlmIHNlbGYuX3BvcHVwX3R5cGUgPT0gInNlbmRfVGltZXNfUHJlc3MiOgogICAgICAgICAgICBzZWxmLl9zZW5kX21zZ190aW1lcyA9IGludChjaG9pY2UpCiAgICAgICAgICAgIGJhLmJ1dHRvbndpZGdldChlZGl0ID0gc2VsZi5fdGltZXNfYnV0dG9uLGxhYmVsPSIlczolZCIlKF9nZXRUcmFuc1RleHQoIlRpbWVzIiksZ2V0YXR0cihzZWxmLCJfc2VuZF9tc2dfdGltZXMiLDEpKSkKICAgICAgICAKICAgICAgICBlbGlmIHNlbGYuX3BvcHVwX3R5cGUgPT0gImNoYXRtZXNzYWdlcHJlc3MiOgogICAgICAgICAgICBpZiBjaG9pY2U9PSJtdXRlIjoKCiAgICAgICAgICAgICAgICB1bm11dGVkX25hbWVzLnJlbW92ZShzZWxmLm1zZ191c2VyX3NlbGVjdGVkKQogICAgICAgICAgICBpZiBjaG9pY2U9PSJ1bm11dGUiOgogICAgICAgICAgICAgICAgdW5tdXRlZF9uYW1lcy5hcHBlbmQoc2VsZi5tc2dfdXNlcl9zZWxlY3RlZCkKCiAgICAgICAgICAgIAogICAgICAgIGVsaWYgc2VsZi5fcG9wdXBfdHlwZSA9PSAicGFydHlNZW1iZXJQcmVzcyI6CiAgICAgICAgICAgIGlmIGNob2ljZSA9PSAia2ljayI6CiAgICAgICAgICAgICAgICBDb25maXJtV2luZG93KHRleHQ9X2dldFRyYW5zVGV4dCgiTm9ybWFsX2tpY2tfY29uZmlybSIpJXNlbGYuX2dldE9iamVjdEJ5SUQoImFjY291bnQiKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uPXNlbGYuX2tpY2tfc2VsZWN0ZWRfcGxheWVyLCBjYW5jZWxfYnV0dG9uPVRydWUsIGNhbmNlbF9pc19zZWxlY3RlZD1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcj1zZWxmLl9iZ19jb2xvciwgdGV4dF9zY2FsZT0xLjAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbl93aWRnZXQ9c2VsZi5nZXRfcm9vdF93aWRnZXQoKSkKCiAgICAgICAgICAgIGVsaWYgY2hvaWNlID09ICJhZG1pbmtpY2siOgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICBDb25maXJtV2luZG93KHRleHQ9X2dldFRyYW5zVGV4dCgiQWRtaW5fQ29tbWFuZF9LaWNrX0NvbmZpcm0iKSVzZWxmLl9nZXRPYmplY3RCeUlEKCJhY2NvdW50IiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uPXNlbGYuX3NlbmRfYWRtaW5fa2lja19jb21tYW5kLCBjYW5jZWxfYnV0dG9uPVRydWUsIGNhbmNlbF9pc19zZWxlY3RlZD1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yPXNlbGYuX2JnX2NvbG9yLCB0ZXh0X3NjYWxlPTEuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5fd2lkZ2V0PXNlbGYuZ2V0X3Jvb3Rfd2lkZ2V0KCkpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxpZiBjaG9pY2UgPT0gIkAgdGhpcyBndXkiOgogICAgICAgICAgICAgICAgQ2hvaWNlRGlzID0gW107TmV3Q2hvaWNlcyA9IFtdCiAgICAgICAgICAgICAgICBhY2NvdW50PXNlbGYuX2dldE9iamVjdEJ5SUQoImFjY291bnQiKQogICAgICAgICAgICAgICAgQ2hvaWNlRGlzLmFwcGVuZChhY2NvdW50KQogICAgICAgICAgICAgICAgdGVtcCA9IHNlbGYuX2dldE9iamVjdEJ5SUQoInBsYXllck5hbWVGdWxsIikKICAgICAgICAgICAgICAgIGlmIHRlbXAgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZSh0ZW1wLHN0cikgYW5kIHRlbXAgbm90IGluIENob2ljZURpczpDaG9pY2VEaXMuYXBwZW5kKHRlbXApCiAgICAgICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKHRlbXAsKGxpc3QsdHVwbGUpKToKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGl0ZW0gaW4gdGVtcDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoaXRlbSxzdHIpIGFuZCBpdGVtIG5vdCBpbiBDaG9pY2VEaXM6Q2hvaWNlRGlzLmFwcGVuZChpdGVtKQogICAgICAgICAgICAgICAgICAgICNwcmludCgiclxcIiIKICAgICAgICAgICAgICAgICAgICBwcmludChhY2NvdW50KQoKICAgICAgICAgICAgICAgIGZvciBpdGVtIGluIENob2ljZURpczoKICAgICAgICAgICAgICAgICAgICBOZXdDaG9pY2VzLmFwcGVuZCh1InNlbGYuX2VkaXRfdGV4dF9tc2dfYm94KCclcycsJ2FkZCcpIiUoaXRlbS5yZXBsYWNlKCInIixyIiciKS5yZXBsYWNlKCciJyxyJ1xcIicpKSkKICAgICAgICAgICAgICAgIGlmICJ3aWxsbmV2ZXJwbGF5YWdhaW4iIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIENob2ljZURpcy5hcHBlbmQoIlNtb290aHkgU2lyIEppIikgICAgICAgICAgICAgICAgICNQbGFzbWEgc2lyIDooCiAgICAgICAgICAgICAgICAgICAgICAgICAjeWVhaCBpdHMgd2VpcmVkIC4uLi5udm0gIC4uaXRzIGp1c3QgZm9yIGZ1bgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgbmljaz1zZWxmLl9nZXRfbmljayhhY2NvdW50KQogICAgICAgICAgICAgICAgICBDaG9pY2VEaXMuYXBwZW5kKG5pY2spCiAgICAgICAgICAgICAgICBOZXdDaG9pY2VzLmFwcGVuZCh1InNlbGYuX29uX25pY2tfcmVuYW1lX3ByZXNzKCclcycpIiUoYWNjb3VudCkpCiAgICAgICAgICAgICAgICBwID0gUG9wdXBNZW51V2luZG93KHBvc2l0aW9uPXBvcHVwX3dpbmRvdy5yb290X3dpZGdldC5nZXRfc2NyZWVuX3NwYWNlX2NlbnRlcigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlPV9nZXRfcG9wdXBfd2luZG93X3NjYWxlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlcz1OZXdDaG9pY2VzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXNfZGlzcGxheT1fY3JlYXRfTHN0cl9saXN0KENob2ljZURpcyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9jaG9pY2U9TmV3Q2hvaWNlc1swXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxlZ2F0ZT1zZWxmKQogICAgICAgICAgICAgICAgc2VsZi5fcG9wdXBfdHlwZSA9ICJDdXN0b21fRXhlY19DaG9pY2UiCiAgICAgICAgICAgIGVsaWYgY2hvaWNlID09ICJjdXN0b21BY3Rpb24iOgogICAgICAgICAgICAgICAgY3VzdG9tQWN0aW9uU2V0cyA9IHNlbGYuX2dldEN1c3RvbVNldHMoKQogICAgICAgICAgICAgICAgY3VzdG9tQWN0aW9uU2V0cyA9IGN1c3RvbUFjdGlvblNldHMuZ2V0KCJwYXJ0eU1lbWJlclByZXNzX0N1c3RvbSIpIGlmIGlzaW5zdGFuY2UoY3VzdG9tQWN0aW9uU2V0cy5nZXQoInBhcnR5TWVtYmVyUHJlc3NfQ3VzdG9tIiksZGljdCkgZWxzZSB7fQogICAgICAgICAgICAgICAgQ2hvaWNlRGlzID0gW107TmV3Q2hvaWNlcyA9IFtdCiAgICAgICAgICAgICAgICBmb3Iga2V5LGl0ZW0gaW4gY3VzdG9tQWN0aW9uU2V0cy5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgIENob2ljZURpcy5hcHBlbmQoa2V5KTtOZXdDaG9pY2VzLmFwcGVuZChpdGVtKQogICAgICAgICAgICAgICAgaWYgbGVuKENob2ljZURpcykgPiAwOgogICAgICAgICAgICAgICAgICAgIHAgPSBQb3B1cE1lbnVXaW5kb3cocG9zaXRpb249cG9wdXBfd2luZG93LnJvb3Rfd2lkZ2V0LmdldF9zY3JlZW5fc3BhY2VfY2VudGVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlPV9nZXRfcG9wdXBfd2luZG93X3NjYWxlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXM9TmV3Q2hvaWNlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlc19kaXNwbGF5PV9jcmVhdF9Mc3RyX2xpc3QoQ2hvaWNlRGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9jaG9pY2U9TmV3Q2hvaWNlc1swXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZWdhdGU9c2VsZikKICAgICAgICAgICAgICAgICAgICBzZWxmLl9wb3B1cF90eXBlID0gImN1c3RvbUFjdGlvbl9wYXJ0eU1lbWJlclByZXNzIgogICAgICAgICAgICAgICAgZWxzZTpiYS5wbGF5c291bmQoYmEuZ2V0c291bmQoImVycm9yIikpO2JhLnNjcmVlbm1lc3NhZ2UoYmEuTHN0cihyZXNvdXJjZT0iZ2V0VGlja2V0c1dpbmRvdy51bmF2YWlsYWJsZVRleHQiKSxjb2xvcj0oMSwwLDApKQogICAgICAgIGVsaWYgc2VsZi5fcG9wdXBfdHlwZSA9PSAibWVudSI6CiAgICAgICAgICAgIGlmIGNob2ljZSBpbiAoIm11dGUiLCAidW5tdXRlIik6CiAgICAgICAgICAgICAgICBjZmcgPSBiYS5hcHAuY29uZmlnCiAgICAgICAgICAgICAgICBjZmdbJ0NoYXQgTXV0ZWQnXSA9IChjaG9pY2UgPT0gJ211dGUnKQogICAgICAgICAgICAgICAgY2ZnLmFwcGx5X2FuZF9jb21taXQoKQogICAgICAgICAgICAgICAgaWYgY2ZnWydDaGF0IE11dGVkJ106CiAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbWNoYXRUaHJlYWQoKS5ydW4oKQogICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlKCkKICAgICAgICAgICAgZWxpZiBjaG9pY2UgaW4gKCJjcmVkaXRzIiwpOgogICAgICAgICAgICAgICAgQ29uZmlybVdpbmRvdyh0ZXh0PSJBZHZhbmNlUGFydHlXaW5kb3cgYnkgTXIuU21vb3RoeSBcbiBleHRlbmRlZCB2ZXJzaW9uIG9mIE1vZGlmeVBhcnR5V2luZG93KFBsYXNtYSBCb3NvbikgXG4gVmVyc2lvbiA1LjMgXG4gRG9udCBtb2RpZnkgb3IgcmVsZWFzZSB0aGUgc291cmNlIGNvZGUgXG4gRGlzY29yZCA6IFxuIG1yLnNtb290aHkjNTgyNCAgICBQbGFzbWEgQm9zb24jNDEwNCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uPXNlbGYuam9pbmJvbWJzcG90LCB3aWR0aD00MjAsaGVpZ2h0PTIwMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW5jZWxfYnV0dG9uPUZhbHNlLCBjYW5jZWxfaXNfc2VsZWN0ZWQ9RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I9c2VsZi5fYmdfY29sb3IsIHRleHRfc2NhbGU9MS4wLCBva190ZXh0PSJNb3JlIG1vZHMgPiIsIGNhbmNlbF90ZXh0PU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luX3dpZGdldD1zZWxmLmdldF9yb290X3dpZGdldCgpKQogICAgICAgICAgICBlbGlmIGNob2ljZSA9PSJjaGF0bG9nZ2VyIjoKICAgICAgICAgICAgICAgICMgQ29sb3JQaWNrZXJFeGFjdChwYXJlbnQ9c2VsZi5nZXRfcm9vdF93aWRnZXQoKSwgcG9zaXRpb249c2VsZi5nZXRfcm9vdF93aWRnZXQoKS5nZXRfc2NyZWVuX3NwYWNlX2NlbnRlcigpLAogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICBpbml0aWFsX2NvbG9yPXNlbGYuX2JnX2NvbG9yLCBkZWxlZ2F0ZT1zZWxmLCB0YWc9JycpCiAgICAgICAgICAgICAgICBnbG9iYWwgY2hhdGxvZ2dlcgogICAgICAgICAgICAgICAgaWYgY2hhdGxvZ2dlcjoKICAgICAgICAgICAgICAgICAgY2hhdGxvZ2dlcj1GYWxzZQogICAgICAgICAgICAgICAgICBiYS5zY3JlZW5tZXNzYWdlKCJDaGF0IGxvZ2dlciB0dXJuZWQgT0ZGIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgIGNoYXRsb2dnZXI9VHJ1ZQogICAgICAgICAgICAgICAgICBjaGF0bG9nZ1RocmVhZCgpLnJ1bigpCiAgICAgICAgICAgICAgICAgIGJhLnNjcmVlbm1lc3NhZ2UoIkNoYXQgbG9nZ2VyIHR1cm5lZCBPTiIpCiAgICAgICAgICAgIGVsaWYgY2hvaWNlPT0nc2NyZWVubXNnJzoKICAgICAgICAgICAgICAgIGdsb2JhbCBzY3JlZW5tc2cKICAgICAgICAgICAgICAgIGlmIHNjcmVlbm1zZzoKICAgICAgICAgICAgICAgICAgICBzY3JlZW5tc2c9RmFsc2UKICAgICAgICAgICAgICAgICAgICBzZWxmLmhpZGVfc2NyZWVuX21zZygpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNjcmVlbm1zZz1UcnVlCiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZXN0b3JlX3NjcmVlbl9tc2coKQogICAgICAgICAgICBlbGlmIGNob2ljZSA9PSAiYWRkUXVpY2tSZXBseSI6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbmV3UmVwbHkgPSBiYS50ZXh0d2lkZ2V0KHF1ZXJ5PXNlbGYuX3RleHRfZmllbGQpCiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHNlbGYuX2dldF9xdWlja19yZXNwb25kcygpCiAgICAgICAgICAgICAgICAgICAgZGF0YS5hcHBlbmQobmV3UmVwbHkpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fd3JpdGVfcXVpY2tfcmVzcG9uZHMoZGF0YSkKICAgICAgICAgICAgICAgICAgICBiYS5zY3JlZW5tZXNzYWdlKF9nZXRUcmFuc1RleHQoIlNvbWV0aGluZ19pc19hZGRlZCIpJW5ld1JlcGx5LGNvbG9yPSgwLDEsMCkpCiAgICAgICAgICAgICAgICAgICAgYmEucGxheXNvdW5kKGJhLmdldHNvdW5kKCJkaW5nU21hbGxIaWdoIikpCiAgICAgICAgICAgICAgICBleGNlcHQ6YmEucHJpbnRfZXhjZXB0aW9uKCkKICAgICAgICAgICAgZWxpZiBjaG9pY2UgPT0gInJlbW92ZVF1aWNrUmVwbHkiOgogICAgICAgICAgICAgICAgUXVpY2tyZXBseSA9IHNlbGYuX2dldF9xdWlja19yZXNwb25kcygpCiAgICAgICAgICAgICAgICBQb3B1cE1lbnVXaW5kb3cocG9zaXRpb249c2VsZi5fdGV4dF9maWVsZC5nZXRfc2NyZWVuX3NwYWNlX2NlbnRlcigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU9X2dldF9wb3B1cF93aW5kb3dfc2NhbGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXM9UXVpY2tyZXBseSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXNfZGlzcGxheT1fY3JlYXRfTHN0cl9saXN0KFF1aWNrcmVwbHkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9jaG9pY2U9UXVpY2tyZXBseVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGVnYXRlPXNlbGYpCiAgICAgICAgICAgICAgICBzZWxmLl9wb3B1cF90eXBlID0gInJlbW92ZVF1aWNrUmVwbHlTZWxlY3QiCiAgICAgICAgICAgIGVsaWYgY2hvaWNlIGluICgiaG9zdEluZm9fRGVidWciLCkgYW5kIGlzaW5zdGFuY2UoX2JhLmdldF9jb25uZWN0aW9uX3RvX2hvc3RfaW5mbygpLGRpY3QpOgogICAgICAgICAgICAgICAgaWYgbGVuKF9iYS5nZXRfY29ubmVjdGlvbl90b19ob3N0X2luZm8oKSkgPiAwOgogICAgICAgICAgICAgICAgICAgICNwcmludChfYmEuZ2V0X2Nvbm5lY3Rpb25fdG9faG9zdF9pbmZvKCksdHlwZShfYmEuZ2V0X2Nvbm5lY3Rpb25fdG9faG9zdF9pbmZvKCkpKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIENob2ljZURpcyA9IGxpc3QoX2JhLmdldF9jb25uZWN0aW9uX3RvX2hvc3RfaW5mbygpLmtleXMoKSkKICAgICAgICAgICAgICAgICAgICBOZXdDaG9pY2VzID0gWyJiYS5zY3JlZW5tZXNzYWdlKHN0cihfYmEuZ2V0X2Nvbm5lY3Rpb25fdG9faG9zdF9pbmZvKCkuZ2V0KCclcycpKSkiJSgoc3RyKGkpKS5yZXBsYWNlKCInIixyIiciKS5yZXBsYWNlKCciJyxyJ1xcIicpKSBmb3IgaSBpbiBDaG9pY2VEaXNdCiAgICAgICAgICAgICAgICAgICAgUG9wdXBNZW51V2luZG93KHBvc2l0aW9uPXBvcHVwX3dpbmRvdy5yb290X3dpZGdldC5nZXRfc2NyZWVuX3NwYWNlX2NlbnRlcigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZT1fZ2V0X3BvcHVwX3dpbmRvd19zY2FsZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2VzPU5ld0Nob2ljZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXNfZGlzcGxheT1fY3JlYXRfTHN0cl9saXN0KENob2ljZURpcyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfY2hvaWNlPU5ld0Nob2ljZXNbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGVnYXRlPXNlbGYpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcG9wdXBfdHlwZSA9ICJDdXN0b21fRXhlY19DaG9pY2UiCiAgICAgICAgICAgICAgICBlbHNlOmJhLnBsYXlzb3VuZChiYS5nZXRzb3VuZCgiZXJyb3IiKSk7YmEuc2NyZWVubWVzc2FnZShiYS5Mc3RyKHJlc291cmNlPSJnZXRUaWNrZXRzV2luZG93LnVuYXZhaWxhYmxlVGV4dCIpLGNvbG9yPSgxLDAsMCkpCiAgICAgICAgICAgIGVsaWYgY2hvaWNlID09ICJ0cmFuc2xhdG9yIjoKICAgICAgICAgICAgICAgIGNoYXRzID0gX2JhLl9nZXRDaGF0TWVzc2FnZXMoKQogICAgICAgICAgICAgICAgaWYgbGVuKGNoYXRzKSA+IDA6CiAgICAgICAgICAgICAgICAgICAgY2hvaWNlcyA9IFsoaXRlbSkgZm9yIGl0ZW0gaW4gY2hhdHNbOjotMV1dCiAgICAgICAgICAgICAgICAgICAgUG9wdXBNZW51V2luZG93KHBvc2l0aW9uPXBvcHVwX3dpbmRvdy5yb290X3dpZGdldC5nZXRfc2NyZWVuX3NwYWNlX2NlbnRlcigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU9X2dldF9wb3B1cF93aW5kb3dfc2NhbGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXM9Y2hvaWNlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXNfZGlzcGxheT1fY3JlYXRfTHN0cl9saXN0KGNob2ljZXMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9jaG9pY2U9Y2hvaWNlc1swXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGVnYXRlPXNlbGYpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcG9wdXBfdHlwZSA9ICJ0cmFuc2xhdG9yX1ByZXNzIgogICAgICAgICAgICAgICAgZWxzZTpiYS5wbGF5c291bmQoYmEuZ2V0c291bmQoImVycm9yIikpO2JhLnNjcmVlbm1lc3NhZ2UoYmEuTHN0cihyZXNvdXJjZT0iZ2V0VGlja2V0c1dpbmRvdy51bmF2YWlsYWJsZVRleHQiKSxjb2xvcj0oMSwwLDApKQogICAgICAgICAgICBlbGlmIGNob2ljZSA9PSAicmVzZXRHYW1lUmVjb3JkIjoKICAgICAgICAgICAgICAgIENvbmZpcm1XaW5kb3codGV4dD1fZ2V0VHJhbnNUZXh0KCJSZXN0YXJ0X0dhbWVfUmVjb3JkX0NvbmZpcm0iKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb249c2VsZi5fcmVzZXRfZ2FtZV9yZWNvcmQsIGNhbmNlbF9idXR0b249VHJ1ZSwgY2FuY2VsX2lzX3NlbGVjdGVkPVRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I9c2VsZi5fYmdfY29sb3IsIHRleHRfc2NhbGU9MS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbl93aWRnZXQ9c2VsZi5nZXRfcm9vdF93aWRnZXQoKSkKICAgICAgICBlbGlmIHNlbGYuX3BvcHVwX3R5cGUgPT0gInRyYW5zbGF0b3JfUHJlc3MiOgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbGVuKHRyYW5UeXBlcykgPT0gMToKICAgICAgICAgICAgICAgIGV4ZWMoInN0YXJ0X25ld190aHJlYWQoT25saW5lVHJhbnNsYXRvci4lcywodSclcycsKSkiJSh0cmFuVHlwZXNbMF0sY2hvaWNlLnJlcGxhY2UoIiciLHIiJyIpLnJlcGxhY2UoJyInLHInXFwiJykpKQogICAgICAgICAgICBlbGlmIGxlbih0cmFuVHlwZXMpID4gMToKICAgICAgICAgICAgICAgIGNob2ljZXMgPSBbInN0YXJ0X25ld190aHJlYWQoT25saW5lVHJhbnNsYXRvci4lcywodSclcycsKSkiJShpdGVtLGNob2ljZS5yZXBsYWNlKCInIixyIiciKS5yZXBsYWNlKCciJyxyJ1xcIicpKSBmb3IgaXRlbSBpbiB0cmFuVHlwZXNdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIFBvcHVwTWVudVdpbmRvdyhwb3NpdGlvbj1wb3B1cF93aW5kb3cucm9vdF93aWRnZXQuZ2V0X3NjcmVlbl9zcGFjZV9jZW50ZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU9X2dldF9wb3B1cF93aW5kb3dfc2NhbGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlcz1jaG9pY2VzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2VzX2Rpc3BsYXk9X2NyZWF0X0xzdHJfbGlzdCh0cmFuVHlwZXMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2Nob2ljZT1jaG9pY2VzWzBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxlZ2F0ZT1zZWxmKQogICAgICAgICAgICAgICAgc2VsZi5fcG9wdXBfdHlwZSA9ICJDdXN0b21fRXhlY19DaG9pY2UiCiAgICAgICAgICAgIGVsc2U6YmEucGxheXNvdW5kKGJhLmdldHNvdW5kKCJlcnJvciIpKTtiYS5zY3JlZW5tZXNzYWdlKGJhLkxzdHIocmVzb3VyY2U9ImdldFRpY2tldHNXaW5kb3cudW5hdmFpbGFibGVUZXh0IiksY29sb3I9KDEsMCwwKSkKICAgICAgICBlbGlmIHNlbGYuX3BvcHVwX3R5cGUgPT0gImN1c3RvbUFjdGlvbl9wYXJ0eU1lbWJlclByZXNzIjoKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGtleVJlcGxhY2VWYWx1ZSA9IChyInskUGxheWVyTmFtZUZ1bGx9IixyInskUGxheWVyTmFtZX0iLHIieyRQbGF5ZXJJRH0iLHIieyRBY2NvdW50SW5mb30iLHIieyRBbGxQbGF5ZXJOYW1lfSIsciJ7JEFsbFBsYXllck5hbWVGdWxsfSIpCiAgICAgICAgICAgICAgICBwb3MgPSBOb25lO2N1cktleVdvcmQgPSBOb25lCiAgICAgICAgICAgICAgICBmb3Iga2V5V29yZCBpbiBrZXlSZXBsYWNlVmFsdWU6CiAgICAgICAgICAgICAgICAgICAgQ3VyUG9zID0gY2hvaWNlLmZpbmQoa2V5V29yZCkKICAgICAgICAgICAgICAgICAgICBpZiBDdXJQb3MgIT0gLTEgYW5kIChwb3MgaXMgTm9uZSBvciBDdXJQb3MgPCBwb3MpOgogICAgICAgICAgICAgICAgICAgICAgICBwb3MgPSBDdXJQb3M7Y3VyS2V5V29yZCA9IGtleVdvcmQKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocG9zLGludCkgYW5kIGlzaW5zdGFuY2UoY3VyS2V5V29yZCxzdHIpOgogICAgICAgICAgICAgICAgICAgIGlmIGN1cktleVdvcmQgaW4gKHIieyRQbGF5ZXJOYW1lRnVsbH0iLHIieyRQbGF5ZXJOYW1lfSIsciJ7JEFsbFBsYXllck5hbWV9IixyInskQWxsUGxheWVyTmFtZUZ1bGx9Iik6CiAgICAgICAgICAgICAgICAgICAgICAgICNpZiBjaG9pY2UuY291bnQoY3VyS2V5V29yZCkgIT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyTmFtZSA9IHNlbGYuX2dldE9iamVjdEJ5SUQoY3VyS2V5V29yZC5yZXBsYWNlKCJ7JCIsIiIpLnJlcGxhY2UoIn0iLCIiKSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShwbGF5ZXJOYW1lLChsaXN0LHR1cGxlKSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDaG9pY2VEaXMgPSBbXTtOZXdDaG9pY2VzID0gW10KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBpIGluIHBsYXllck5hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2hvaWNlRGlzLmFwcGVuZChpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5ld0Nob2ljZXMuYXBwZW5kKGNob2ljZS5yZXBsYWNlKGN1cktleVdvcmQsKGkucmVwbGFjZSgiJyIsciInIikucmVwbGFjZSgnIicscidcXCInKSksMSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwID0gUG9wdXBNZW51V2luZG93KHBvc2l0aW9uPXBvcHVwX3dpbmRvdy5yb290X3dpZGdldC5nZXRfc2NyZWVuX3NwYWNlX2NlbnRlcigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlPV9nZXRfcG9wdXBfd2luZG93X3NjYWxlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvaWNlcz1OZXdDaG9pY2VzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXNfZGlzcGxheT1fY3JlYXRfTHN0cl9saXN0KENob2ljZURpcyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9jaG9pY2U9TmV3Q2hvaWNlc1swXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxlZ2F0ZT1zZWxmKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcG9wdXBfdHlwZSA9ICJjdXN0b21BY3Rpb25fcGFydHlNZW1iZXJQcmVzcyIKICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKHBsYXllck5hbWUsc3RyKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucG9wdXBfbWVudV9zZWxlY3RlZF9jaG9pY2UocG9wdXBfd2luZG93LGNob2ljZS5yZXBsYWNlKGN1cktleVdvcmQsKHBsYXllck5hbWUucmVwbGFjZSgiJyIsciInIikucmVwbGFjZSgnIicscidcXCInKSksMSkpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6YmEuc2NyZWVubWVzc2FnZShfZ2V0VHJhbnNUZXh0KCJOb192YWxpZF9wbGF5ZXJfZm91bmQiKSwoMSwwLDApKTtiYS5wbGF5c291bmQoYmEuZ2V0c291bmQoImVycm9yIikpCiAgICAgICAgICAgICAgICAgICAgZWxpZiBjdXJLZXlXb3JkIGluIChyInskUGxheWVySUR9IiwpICE9IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllcklEID0gc2VsZi5fZ2V0T2JqZWN0QnlJRCgiUGxheWVySUQiKQogICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXJOYW1lID0gc2VsZi5fZ2V0T2JqZWN0QnlJRCgiUGxheWVyTmFtZSIpCiAgICAgICAgICAgICAgICAgICAgICAgICNwcmludChwbGF5ZXJJRCxwbGF5ZXJOYW1lKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHBsYXllcklELChsaXN0LHR1cGxlKSkgYW5kIGlzaW5zdGFuY2UocGxheWVyTmFtZSwobGlzdCx0dXBsZSkpIGFuZCBsZW4ocGxheWVyTmFtZSkgPT0gbGVuKHBsYXllcklEKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENob2ljZURpcyA9IFtdO05ld0Nob2ljZXMgPSBbXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGkxLGkyIGluIHBsYXllck5hbWUscGxheWVySUQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2hvaWNlRGlzLmFwcGVuZChpMSk7TmV3Q2hvaWNlcy5hcHBlbmQoY2hvaWNlLnJlcGxhY2UociJ7JFBsYXllcklEfSIsc3RyKGkyKS5yZXBsYWNlKCInIixyIiciKS5yZXBsYWNlKCciJyxyJ1xcIicpKSwxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcCA9IFBvcHVwTWVudVdpbmRvdyhwb3NpdGlvbj1wb3B1cF93aW5kb3cucm9vdF93aWRnZXQuZ2V0X3NjcmVlbl9zcGFjZV9jZW50ZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZT1fZ2V0X3BvcHVwX3dpbmRvd19zY2FsZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob2ljZXM9TmV3Q2hvaWNlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2VzX2Rpc3BsYXk9X2NyZWF0X0xzdHJfbGlzdChDaG9pY2VEaXMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfY2hvaWNlPU5ld0Nob2ljZXNbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZWdhdGU9c2VsZikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3BvcHVwX3R5cGUgPSAiY3VzdG9tQWN0aW9uX3BhcnR5TWVtYmVyUHJlc3MiCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShwbGF5ZXJJRCxpbnQpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wb3B1cF9tZW51X3NlbGVjdGVkX2Nob2ljZShwb3B1cF93aW5kb3csY2hvaWNlLnJlcGxhY2UociJ7JFBsYXllcklEfSIsc3RyKHBsYXllcklEKS5yZXBsYWNlKCInIixyIiciKS5yZXBsYWNlKCciJyxyJ1xcIicpKSkKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZTpiYS5zY3JlZW5tZXNzYWdlKF9nZXRUcmFuc1RleHQoIk5vX3ZhbGlkX3BsYXllcl9pZF9mb3VuZCIpLCgxLDAsMCkpO2JhLnBsYXlzb3VuZChiYS5nZXRzb3VuZCgiZXJyb3IiKSkKICAgICAgICAgICAgICAgICAgICBlbGlmIGN1cktleVdvcmQgaW4gKHIieyRBY2NvdW50SW5mb30iLCkgIT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wb3B1cF9tZW51X3NlbGVjdGVkX2Nob2ljZShwb3B1cF93aW5kb3csY2hvaWNlLnJlcGxhY2UociJ7JEFjY291bnRJbmZvfSIsKHN0cihzZWxmLl9nZXRPYmplY3RCeUlEKCJyb3N0ZXIiKSkpLnJlcGxhY2UoIiciLHIiJyIpLnJlcGxhY2UoJyInLHInXFwiJyksMSkpCiAgICAgICAgICAgICAgICBlbHNlOmV4ZWMoY2hvaWNlKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6YmEuc2NyZWVubWVzc2FnZShyZXByKGUpLCgxLDAsMCkpCiAgICAgICAgZWxpZiBzZWxmLl9wb3B1cF90eXBlID09ICJRdWlja01lc3NhZ2VTZWxlY3QiOgogICAgICAgICAgICAjYmEudGV4dHdpZGdldChlZGl0PXNlbGYuX3RleHRfZmllbGQsdGV4dD1zZWxmLl9nZXRfcXVpY2tfcmVzcG9uZHMoKVtpbmRleF0pCiAgICAgICAgICAgIHNlbGYuX2VkaXRfdGV4dF9tc2dfYm94KGNob2ljZSwiYWRkIikKICAgICAgICBlbGlmIHNlbGYuX3BvcHVwX3R5cGUgPT0gInJlbW92ZVF1aWNrUmVwbHlTZWxlY3QiOgogICAgICAgICAgICBkYXRhID0gc2VsZi5fZ2V0X3F1aWNrX3Jlc3BvbmRzKCkKICAgICAgICAgICAgaWYgbGVuKGRhdGEpID4gMCBhbmQgY2hvaWNlIGluIGRhdGE6CiAgICAgICAgICAgICAgICBkYXRhLnJlbW92ZShjaG9pY2UpCiAgICAgICAgICAgICAgICBzZWxmLl93cml0ZV9xdWlja19yZXNwb25kcyhkYXRhKQogICAgICAgICAgICAgICAgYmEuc2NyZWVubWVzc2FnZShfZ2V0VHJhbnNUZXh0KCJTb21ldGhpbmdfaXNfcmVtb3ZlZCIpJWNob2ljZSwoMSwwLDApKQogICAgICAgICAgICAgICAgYmEucGxheXNvdW5kKGJhLmdldHNvdW5kKCJzaGllbGREb3duIikpCiAgICAgICAgICAgIGVsc2U6YmEuc2NyZWVubWVzc2FnZShiYS5Mc3RyKHJlc291cmNlPSJlcnJvclRleHQiKSwoMSwwLDApKTtiYS5wbGF5c291bmQoYmEuZ2V0c291bmQoImVycm9yIikpCiAgICAgICAgZWxpZiBjaG9pY2Uuc3RhcnRzd2l0aCgiY3VzdG9tX0V4ZWNfQ2hvaWNlXyIpIG9yIHNlbGYuX3BvcHVwX3R5cGUgPT0gIkN1c3RvbV9FeGVjX0Nob2ljZSI6CiAgICAgICAgICAgIGV4ZWMoY2hvaWNlW2xlbigiY3VzdG9tX0V4ZWNfQ2hvaWNlXyIpOl0gaWYgY2hvaWNlLnN0YXJ0c3dpdGgoImN1c3RvbV9FeGVjX0Nob2ljZV8iKSBlbHNlIGNob2ljZSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludCgidW5oYW5kbGVkIHBvcHVwIHR5cGU6ICIrc3RyKHNlbGYuX3BvcHVwX3R5cGUpKQoKZGVmIHJlcGxhY2VyKCk6CiAgX2JhLmNvbm5lY3RfdG9fcGFydHk9bmV3Y29ubmVjdF90b19wYXJ0eQo="))
# ba_meta export plugin
class bySmoothy(ba.Plugin):
    def __init__(self):
        if _ba.env().get("build_number",0) >= 20246:
            replacer()
            bastd_party.PartyWindow = ModifiedPartyWindow
        else:print("AdvancePartyWindow only runs with BombSquad version equal or higher than 1.5.29., target 1.6 ")

# SHARING IS CARING :)